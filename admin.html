<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1; --primary-light: #EEF2FF;
            --success: #10B981; --success-light: #D1FAE5;
            --warning: #F59E0B; --warning-light: #FEF3C7;
            --danger: #EF4444; --danger-light: #FEE2E2;
            --purple: #8B5CF6; --purple-light: #EDE9FE;
            --cyan: #06B6D4; --cyan-light: #CFFAFE;
            --bg: #F8FAFC; --card: #FFFFFF;
            --text: #1E293B; --text-light: #64748B; --border: #E2E8F0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, var(--primary), #8B5CF6); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; display: flex; align-items: center; gap: 10px; }
        .header-btns { display: flex; gap: 10px; }
        .header-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; font-family: inherit; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .header-btn:hover { background: rgba(255,255,255,0.3); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: var(--card); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .tab:hover { border-color: var(--primary); }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-header h2 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* Sections List */
        .section-item { background: var(--bg); border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
        .section-header { padding: 16px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .section-header:hover { background: var(--primary-light); }
        .section-icon { width: 50px; height: 50px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .section-info { flex: 1; }
        .section-info h3 { font-size: 16px; margin-bottom: 4px; }
        .section-info p { font-size: 12px; color: var(--text-light); }
        .section-badges { display: flex; gap: 6px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge.questions { background: var(--cyan-light); color: var(--cyan); }
        .badge.action { background: var(--purple-light); color: var(--purple); }
        .section-actions { display: flex; gap: 6px; }
        .icon-btn { width: 36px; height: 36px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .icon-btn.edit { background: var(--warning-light); color: var(--warning); }
        .icon-btn.delete { background: var(--danger-light); color: var(--danger); }
        .icon-btn.add { background: var(--success-light); color: var(--success); }
        
        .section-content { padding: 0 20px 20px; display: none; }
        .section-item.open .section-content { display: block; }
        
        /* Questions */
        .questions-list { background: white; border-radius: 10px; padding: 15px; }
        .question-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; }
        .question-order { width: 30px; height: 30px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }
        .question-info { flex: 1; }
        .question-info h4 { font-size: 14px; margin-bottom: 2px; }
        .question-info span { font-size: 11px; color: var(--text-light); }
        .question-var { background: var(--cyan-light); color: var(--cyan); padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        
        .add-question-btn { width: 100%; padding: 12px; border: 2px dashed var(--border); border-radius: 8px; background: transparent; color: var(--text-light); font-family: inherit; cursor: pointer; margin-top: 10px; }
        .add-question-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        /* Action Box */
        .action-box { background: linear-gradient(135deg, var(--purple-light), var(--primary-light)); border-radius: 10px; padding: 15px; margin-top: 15px; }
        .action-box h4 { font-size: 13px; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .action-type { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: white; border-radius: 20px; font-size: 12px; font-weight: 600; }
        
        /* Files Page */
        .upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; }
        .upload-zone:hover { border-color: var(--primary); background: var(--primary-light); }
        .upload-zone span { font-size: 40px; display: block; margin-bottom: 10px; }
        .upload-zone input { display: none; }
        
        .files-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .file-card { background: var(--bg); border-radius: 12px; padding: 15px; text-align: center; position: relative; }
        .file-card .icon { font-size: 36px; margin-bottom: 8px; }
        .file-card .name { font-size: 12px; font-weight: 600; word-break: break-all; }
        .file-card .delete { position: absolute; top: 8px; left: 8px; width: 24px; height: 24px; border-radius: 50%; background: var(--danger); color: white; border: none; cursor: pointer; }
        
        /* Settings */
        .settings-group { margin-bottom: 20px; }
        .settings-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .settings-group input { width: 100%; max-width: 500px; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 14px; }
        .settings-group input:focus { outline: none; border-color: var(--primary); }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-box { background: white; border-radius: 16px; padding: 25px; width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 18px; }
        .close-btn { width: 36px; height: 36px; border: none; border-radius: 8px; background: var(--bg); font-size: 18px; cursor: pointer; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 14px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .action-types { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 16px; }
        .action-type-btn { padding: 12px 8px; border: 2px solid var(--border); border-radius: 10px; text-align: center; cursor: pointer; font-size: 11px; }
        .action-type-btn:hover { border-color: var(--primary); }
        .action-type-btn.active { border-color: var(--primary); background: var(--primary-light); }
        .action-type-btn span { font-size: 20px; display: block; margin-bottom: 4px; }
        
        .files-select { display: flex; flex-wrap: wrap; gap: 6px; padding: 12px; background: var(--bg); border-radius: 8px; min-height: 50px; margin-top: 8px; }
        .file-tag { display: flex; align-items: center; gap: 4px; padding: 4px 10px; background: var(--primary-light); color: var(--primary); border-radius: 20px; font-size: 12px; }
        .file-tag button { background: none; border: none; color: var(--danger); cursor: pointer; }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btns button { flex: 1; padding: 14px; border-radius: 10px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: var(--bg); color: var(--text); }
        .btn-save { background: var(--success); color: white; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--success); color: white; padding: 12px 30px; border-radius: 10px; font-weight: 600; opacity: 0; transition: 0.3s; z-index: 2000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .empty { text-align: center; padding: 50px; color: var(--text-light); }
        .empty span { font-size: 50px; display: block; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
        <div class="header-btns">
            <button class="header-btn" onclick="window.open('index.html','_blank')">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙÙˆØ±Ù…</button>
        </div>
    </div>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="showPage('sections', this)">ğŸ“‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
            <div class="tab" onclick="showPage('files', this)">ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
            <div class="tab" onclick="showPage('settings', this)">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        </div>
        
        <!-- Sections Page -->
        <div class="page active" id="page-sections">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
                    <button class="btn btn-success" onclick="openSectionModal()">â• Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <div id="sectionsContainer"></div>
            </div>
        </div>
        
        <!-- Files Page -->
        <div class="page" id="page-files">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</h2>
                </div>
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <span>ğŸ“¤</span>
                    <p>Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                    <p style="font-size:12px;color:var(--text-light);margin-top:5px;">PDF, Word, Excel, ØµÙˆØ±</p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.png,.jpg,.jpeg">
                </div>
                <div class="files-grid" id="filesGrid"></div>
            </div>
        </div>
        
        <!-- Settings Page -->
        <div class="page" id="page-settings">
            <div class="card">
                <div class="card-header">
                    <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                </div>
                <div class="settings-group">
                    <label>ğŸ”‘ Gemini API Key</label>
                    <input type="password" id="geminiKey" placeholder="AIzaSy...">
                </div>
                <div class="settings-group">
                    <label>ğŸ”— Webhook URL (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" id="webhookUrl" placeholder="https://hook.make.com/...">
                </div>
                <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
        </div>
    </div>
    
    <!-- Section Modal -->
    <div class="modal" id="sectionModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2 id="sectionModalTitle">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</h2>
                <button class="close-btn" onclick="closeModal('sectionModal')">Ã—</button>
            </div>
            <form onsubmit="saveSection(event)">
                <input type="hidden" id="sectionId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
                        <input type="text" id="sectionIcon" placeholder="ğŸ’°" maxlength="2" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ±ØªÙŠØ¨</label>
                        <input type="number" id="sectionOrder" value="0" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ</label>
                        <input type="text" id="sectionNameAr" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
                        <input type="text" id="sectionNameEn" required>
                    </div>
                </div>
                
                <h3 style="font-size:14px;margin:20px 0 12px;display:flex;align-items:center;gap:8px;">âš¡ Ø§Ù„Ø£ÙƒØ´Ù† (Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©)</h3>
                
                <div class="action-types">
                    <div class="action-type-btn active" data-type="ai" onclick="setActionType('ai')"><span>ğŸ¤–</span>AI</div>
                    <div class="action-type-btn" data-type="static" onclick="setActionType('static')"><span>ğŸ“</span>Ø«Ø§Ø¨ØªØ©</div>
                    <div class="action-type-btn" data-type="phone" onclick="setActionType('phone')"><span>ğŸ“</span>Ø§ØªØµØ§Ù„</div>
                    <div class="action-type-btn" data-type="whatsapp" onclick="setActionType('whatsapp')"><span>ğŸ’¬</span>ÙˆØ§ØªØ³Ø§Ø¨</div>
                    <div class="action-type-btn" data-type="webhook" onclick="setActionType('webhook')"><span>ğŸ”—</span>Webhook</div>
                </div>
                
                <div id="aiSection">
                    <div class="form-group">
                        <label>ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª (AI ÙŠØ¨Ø­Ø« ÙÙŠÙ‡Ø§)</label>
                        <select id="fileSelectSection" onchange="addFileToSection()">
                            <option value="">-- Ø§Ø®ØªØ± Ù…Ù„Ù --</option>
                        </select>
                        <div class="files-select" id="selectedSectionFiles"></div>
                    </div>
                    <div class="form-group">
                        <label>ØªØ¹Ù„ÙŠÙ…Ø§Øª AI</label>
                        <textarea id="sectionPrompt" rows="2" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©..."></textarea>
                    </div>
                </div>
                
                <div id="staticSection" style="display:none;">
                    <div class="form-group">
                        <label>Ø§Ù„Ø±Ø¯ Ø¹Ø±Ø¨ÙŠ</label>
                        <textarea id="sectionRespAr" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø±Ø¯ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
                        <textarea id="sectionRespEn" rows="3"></textarea>
                    </div>
                </div>
                
                <div id="phoneSection" style="display:none;">
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø©)</label>
                        <input type="text" id="sectionPhone" placeholder="966501234567">
                    </div>
                </div>
                
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" onclick="closeModal('sectionModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Question Modal -->
    <div class="modal" id="questionModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2 id="questionModalTitle">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h2>
                <button class="close-btn" onclick="closeModal('questionModal')">Ã—</button>
            </div>
            <form onsubmit="saveQuestion(event)">
                <input type="hidden" id="questionId">
                <input type="hidden" id="questionSectionId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
                        <input type="text" id="questionIcon" placeholder="â“" maxlength="2" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ±ØªÙŠØ¨</label>
                        <input type="number" id="questionOrder" value="1" min="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ø±Ø¨ÙŠ</label>
                        <input type="text" id="questionLabelAr" placeholder="Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
                        <input type="text" id="questionLabelEn" placeholder="What's your name?" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ± (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
                        <input type="text" id="questionVar" placeholder="name, emp_id, month" required>
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</label>
                        <select id="questionType" onchange="toggleOptionsField()">
                            <option value="text">Ù†Øµ</option>
                            <option value="number">Ø±Ù‚Ù…</option>
                            <option value="select">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</option>
                            <option value="date">ØªØ§Ø±ÙŠØ®</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="optionsField" style="display:none;">
                    <label>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø§Ø®ØªÙŠØ§Ø±)</label>
                    <textarea id="questionOptions" rows="3" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ&#10;Ø±Ø§ØªØ¨ Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚"></textarea>
                </div>
                
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" onclick="closeModal('questionModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://nrsnsysjmhboovutirdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yc25zeXNqbWhib292dXRpcmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDYxNjYsImV4cCI6MjA4NzE4MjE2Nn0.A6XRe0wUA267hogwWnNpXe08B-MrL1HSjBVbURyLdsU';
        
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let sections = [], questions = [], files = [], settings = {};
        let actionType = 'ai';
        let selectedFiles = [];

        // Load Data
        async function loadData() {
            try {
                const { data: s } = await db.from('settings').select('*').limit(1).single();
                if (s) {
                    settings = s;
                    document.getElementById('geminiKey').value = s.gemini_key || '';
                    document.getElementById('webhookUrl').value = s.webhook_url || '';
                }
                
                const { data: sec } = await db.from('sections').select('*').eq('is_active', true).order('sort_order');
                sections = sec || [];
                
                const { data: q } = await db.from('questions').select('*').eq('is_active', true).order('sort_order');
                questions = q || [];
                
                await loadFiles();
                renderSections();
            } catch (e) { console.error(e); }
        }

        async function loadFiles() {
            const { data } = await db.storage.from('files').list();
            files = data || [];
            renderFiles();
            updateFileSelects();
        }

        // Render Sections
        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            if (!sections.length) {
                container.innerHTML = '<div class="empty"><span>ğŸ“­</span><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…</p><p style="font-size:13px;">Ø§Ø¶ØºØ· "Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯" Ù„Ù„Ø¨Ø¯Ø¡</p></div>';
                return;
            }
            
            container.innerHTML = sections.map(sec => {
                const secQuestions = questions.filter(q => q.section_id === sec.id);
                const actionLabel = { ai: 'ğŸ¤– AI', static: 'ğŸ“ Ø«Ø§Ø¨ØªØ©', phone: 'ğŸ“ Ø§ØªØµØ§Ù„', whatsapp: 'ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨', webhook: 'ğŸ”— Webhook' }[sec.action_type] || 'ğŸ¤– AI';
                
                return `
                    <div class="section-item" id="sec_${sec.id}">
                        <div class="section-header" onclick="toggleSection('${sec.id}')">
                            <div class="section-icon">${sec.icon}</div>
                            <div class="section-info">
                                <h3>${sec.name_ar}</h3>
                                <p>${sec.name_en}</p>
                            </div>
                            <div class="section-badges">
                                <span class="badge questions">â“ ${secQuestions.length} Ø³Ø¤Ø§Ù„</span>
                                <span class="badge action">${actionLabel}</span>
                            </div>
                            <div class="section-actions" onclick="event.stopPropagation()">
                                <button class="icon-btn add" onclick="openQuestionModal('${sec.id}')" title="Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„">â•</button>
                                <button class="icon-btn edit" onclick="editSection('${sec.id}')" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                                <button class="icon-btn delete" onclick="deleteSection('${sec.id}')" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="section-content">
                            <div class="questions-list">
                                <h4 style="font-size:13px;color:var(--text-light);margin-bottom:12px;">â“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨)</h4>
                                ${secQuestions.length ? secQuestions.map(q => `
                                    <div class="question-item">
                                        <div class="question-order">${q.sort_order}</div>
                                        <span style="font-size:18px;">${q.icon}</span>
                                        <div class="question-info">
                                            <h4>${q.label_ar}</h4>
                                            <span>${q.label_en}</span>
                                        </div>
                                        <span class="question-var">{${q.var_name}}</span>
                                        <div>
                                            <button class="icon-btn edit" onclick="editQuestion('${q.id}')">âœï¸</button>
                                            <button class="icon-btn delete" onclick="deleteQuestion('${q.id}')">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                `).join('') : '<p style="text-align:center;color:var(--text-light);padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©</p>'}
                                <button class="add-question-btn" onclick="openQuestionModal('${sec.id}')">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
                            </div>
                            <div class="action-box">
                                <h4>âš¡ Ø§Ù„Ø£ÙƒØ´Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h4>
                                <span class="action-type">${actionLabel}</span>
                                ${sec.action_files?.length ? `<p style="font-size:11px;margin-top:8px;">ğŸ“ ${sec.action_files.join(', ')}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Files
        function renderFiles() {
            const el = document.getElementById('filesGrid');
            if (!files.length) { el.innerHTML = ''; return; }
            el.innerHTML = files.map(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                let icon = 'ğŸ“„';
                if (ext === 'pdf') icon = 'ğŸ“•';
                else if (['doc','docx'].includes(ext)) icon = 'ğŸ“˜';
                else if (['xls','xlsx','csv'].includes(ext)) icon = 'ğŸ“—';
                else if (['png','jpg','jpeg'].includes(ext)) icon = 'ğŸ–¼ï¸';
                return `<div class="file-card"><button class="delete" onclick="deleteFile('${f.name}')">Ã—</button><div class="icon">${icon}</div><div class="name">${f.name}</div></div>`;
            }).join('');
        }

        function updateFileSelects() {
            const options = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù„Ù --</option>' + files.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            document.getElementById('fileSelectSection').innerHTML = options;
        }

        // Pages
        window.showPage = (page, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            el.classList.add('active');
        };

        window.toggleSection = (id) => document.getElementById('sec_' + id)?.classList.toggle('open');

        // Section Modal
        window.openSectionModal = () => {
            document.getElementById('sectionModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…';
            document.getElementById('sectionId').value = '';
            document.getElementById('sectionIcon').value = '';
            document.getElementById('sectionOrder').value = sections.length;
            document.getElementById('sectionNameAr').value = '';
            document.getElementById('sectionNameEn').value = '';
            document.getElementById('sectionPrompt').value = '';
            document.getElementById('sectionRespAr').value = '';
            document.getElementById('sectionRespEn').value = '';
            document.getElementById('sectionPhone').value = '';
            selectedFiles = [];
            renderSelectedFiles();
            setActionType('ai');
            openModal('sectionModal');
        };

        window.editSection = (id) => {
            const sec = sections.find(s => s.id === id);
            if (!sec) return;
            document.getElementById('sectionModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…';
            document.getElementById('sectionId').value = id;
            document.getElementById('sectionIcon').value = sec.icon;
            document.getElementById('sectionOrder').value = sec.sort_order;
            document.getElementById('sectionNameAr').value = sec.name_ar;
            document.getElementById('sectionNameEn').value = sec.name_en;
            document.getElementById('sectionPrompt').value = sec.action_prompt || '';
            document.getElementById('sectionRespAr').value = sec.action_response_ar || '';
            document.getElementById('sectionRespEn').value = sec.action_response_en || '';
            document.getElementById('sectionPhone').value = sec.action_phone || '';
            selectedFiles = sec.action_files || [];
            renderSelectedFiles();
            setActionType(sec.action_type || 'ai');
            openModal('sectionModal');
        };

        window.saveSection = async (e) => {
            e.preventDefault();
            const id = document.getElementById('sectionId').value;
            const data = {
                icon: document.getElementById('sectionIcon').value,
                sort_order: parseInt(document.getElementById('sectionOrder').value) || 0,
                name_ar: document.getElementById('sectionNameAr').value,
                name_en: document.getElementById('sectionNameEn').value,
                action_type: actionType,
                action_files: selectedFiles.length ? selectedFiles : null,
                action_prompt: document.getElementById('sectionPrompt').value || null,
                action_response_ar: document.getElementById('sectionRespAr').value || null,
                action_response_en: document.getElementById('sectionRespEn').value || null,
                action_phone: document.getElementById('sectionPhone').value || null
            };
            
            try {
                if (id) await db.from('sections').update(data).eq('id', id);
                else await db.from('sections').insert(data);
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
                closeModal('sectionModal');
                loadData();
            } catch (err) { toast('Ø®Ø·Ø£: ' + err.message, true); }
        };

        window.deleteSection = async (id) => {
            if (!confirm('Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙˆÙƒÙ„ Ø£Ø³Ø¦Ù„ØªÙ‡ØŸ')) return;
            await db.from('sections').update({ is_active: false }).eq('id', id);
            toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            loadData();
        };

        window.setActionType = (type) => {
            actionType = type;
            document.querySelectorAll('.action-type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === type));
            document.getElementById('aiSection').style.display = type === 'ai' ? '' : 'none';
            document.getElementById('staticSection').style.display = type === 'static' ? '' : 'none';
            document.getElementById('phoneSection').style.display = (type === 'phone' || type === 'whatsapp') ? '' : 'none';
        };

        window.addFileToSection = () => {
            const select = document.getElementById('fileSelectSection');
            if (select.value && !selectedFiles.includes(select.value)) {
                selectedFiles.push(select.value);
                renderSelectedFiles();
            }
            select.value = '';
        };

        window.removeFileFromSection = (file) => {
            selectedFiles = selectedFiles.filter(f => f !== file);
            renderSelectedFiles();
        };

        function renderSelectedFiles() {
            const container = document.getElementById('selectedSectionFiles');
            container.innerHTML = selectedFiles.length 
                ? selectedFiles.map(f => `<div class="file-tag">${f}<button onclick="removeFileFromSection('${f}')">Ã—</button></div>`).join('')
                : '<span style="color:var(--text-light);font-size:12px;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª</span>';
        }

        // Question Modal
        window.openQuestionModal = (sectionId) => {
            const secQuestions = questions.filter(q => q.section_id === sectionId);
            document.getElementById('questionModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„';
            document.getElementById('questionId').value = '';
            document.getElementById('questionSectionId').value = sectionId;
            document.getElementById('questionIcon').value = 'â“';
            document.getElementById('questionOrder').value = secQuestions.length + 1;
            document.getElementById('questionLabelAr').value = '';
            document.getElementById('questionLabelEn').value = '';
            document.getElementById('questionVar').value = '';
            document.getElementById('questionType').value = 'text';
            document.getElementById('questionOptions').value = '';
            document.getElementById('optionsField').style.display = 'none';
            openModal('questionModal');
        };

        window.editQuestion = (id) => {
            const q = questions.find(x => x.id === id);
            if (!q) return;
            document.getElementById('questionModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„';
            document.getElementById('questionId').value = id;
            document.getElementById('questionSectionId').value = q.section_id;
            document.getElementById('questionIcon').value = q.icon;
            document.getElementById('questionOrder').value = q.sort_order;
            document.getElementById('questionLabelAr').value = q.label_ar;
            document.getElementById('questionLabelEn').value = q.label_en;
            document.getElementById('questionVar').value = q.var_name;
            document.getElementById('questionType').value = q.input_type;
            document.getElementById('questionOptions').value = q.options || '';
            document.getElementById('optionsField').style.display = q.input_type === 'select' ? '' : 'none';
            openModal('questionModal');
        };

        window.saveQuestion = async (e) => {
            e.preventDefault();
            const id = document.getElementById('questionId').value;
            const data = {
                section_id: document.getElementById('questionSectionId').value,
                icon: document.getElementById('questionIcon').value,
                sort_order: parseInt(document.getElementById('questionOrder').value) || 1,
                label_ar: document.getElementById('questionLabelAr').value,
                label_en: document.getElementById('questionLabelEn').value,
                var_name: document.getElementById('questionVar').value,
                input_type: document.getElementById('questionType').value,
                options: document.getElementById('questionOptions').value || null
            };
            
            try {
                if (id) await db.from('questions').update(data).eq('id', id);
                else await db.from('questions').insert(data);
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
                closeModal('questionModal');
                loadData();
            } catch (err) { toast('Ø®Ø·Ø£: ' + err.message, true); }
        };

        window.deleteQuestion = async (id) => {
            if (!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) return;
            await db.from('questions').update({ is_active: false }).eq('id', id);
            toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            loadData();
        };

        window.toggleOptionsField = () => {
            document.getElementById('optionsField').style.display = document.getElementById('questionType').value === 'select' ? '' : 'none';
        };

        // Files
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            for (const f of e.target.files) {
                toast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ' + f.name + '...');
                try {
                    const fileName = Date.now() + '_' + f.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                    const { error } = await db.storage.from('files').upload(fileName, f, { upsert: true });
                    if (error) toast('Ø®Ø·Ø£: ' + error.message, true);
                    else toast('ØªÙ… âœ…');
                } catch (err) { toast('Ø®Ø·Ø£', true); }
            }
            e.target.value = '';
            loadFiles();
        });

        window.deleteFile = async (name) => {
            if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØŸ')) return;
            await db.storage.from('files').remove([name]);
            toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            loadFiles();
        };

        // Settings
        window.saveSettings = async () => {
            const data = { gemini_key: document.getElementById('geminiKey').value, webhook_url: document.getElementById('webhookUrl').value };
            try {
                if (settings.id) await db.from('settings').update(data).eq('id', settings.id);
                else await db.from('settings').insert(data);
                settings = { ...settings, ...data };
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
            } catch (e) { toast('Ø®Ø·Ø£', true); }
        };

        // Helpers
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        
        function toast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
        });

        loadData();
    </script>
</body>
</html>
