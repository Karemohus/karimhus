<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5; --primary-light: #EEF2FF;
            --success: #10B981; --success-light: #D1FAE5;
            --warning: #F59E0B; --warning-light: #FEF3C7;
            --danger: #EF4444; --danger-light: #FEE2E2;
            --purple: #8B5CF6; --purple-light: #EDE9FE;
            --blue: #3B82F6; --blue-light: #DBEAFE;
            --bg: #F1F5F9; --card: #FFFFFF;
            --text: #1E293B; --text-light: #64748B; --border: #E2E8F0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); min-height: 100vh; }
        
        .sidebar { position: fixed; top: 0; right: 0; width: 250px; height: 100vh; background: var(--card); border-left: 1px solid var(--border); padding: 20px; }
        .logo { font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; border-radius: 10px; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-light); font-weight: 500; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: var(--primary-light); color: var(--primary); }
        .nav-item span { font-size: 18px; }
        
        .main { margin-right: 250px; padding: 20px; }
        
        .header { background: linear-gradient(135deg, var(--primary), #7C3AED); color: white; padding: 25px; border-radius: 16px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 22px; }
        .header-actions { display: flex; gap: 10px; }
        .status { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 13px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.online { background: #34D399; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn:hover { transform: translateY(-1px); }
        .btn-white { background: white; color: var(--primary); }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: var(--card); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .tab:hover { border-color: var(--primary); }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border); }
        .card-header h2 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        
        .settings-row { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .settings-row label { font-weight: 600; min-width: 120px; }
        .settings-row input { flex: 1; min-width: 200px; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; font-family: inherit; }
        .settings-row input:focus { outline: none; border-color: var(--primary); }
        
        /* Files Section */
        .upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: 0.2s; }
        .upload-zone:hover { border-color: var(--primary); background: var(--primary-light); }
        .upload-zone.dragover { border-color: var(--success); background: var(--success-light); }
        .upload-zone span { font-size: 48px; display: block; margin-bottom: 10px; }
        .upload-zone p { color: var(--text-light); }
        .upload-zone input { display: none; }
        
        .files-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .file-card { background: var(--bg); border-radius: 12px; padding: 15px; text-align: center; position: relative; }
        .file-card .icon { font-size: 40px; margin-bottom: 10px; }
        .file-card .name { font-weight: 600; font-size: 13px; word-break: break-all; }
        .file-card .size { font-size: 11px; color: var(--text-light); margin-top: 5px; }
        .file-card .delete { position: absolute; top: 10px; left: 10px; width: 28px; height: 28px; border-radius: 50%; background: var(--danger); color: white; border: none; cursor: pointer; font-size: 14px; }
        
        /* Categories */
        .category { background: var(--bg); border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
        .cat-header { padding: 15px; background: var(--primary-light); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .cat-header:hover { background: #E0E7FF; }
        .cat-title { display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .cat-title .icon { width: 40px; height: 40px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .cat-actions { display: flex; gap: 6px; }
        
        .icon-btn { width: 32px; height: 32px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .icon-btn.edit { background: var(--warning-light); color: var(--warning); }
        .icon-btn.delete { background: var(--danger-light); color: var(--danger); }
        .icon-btn.add { background: var(--success-light); color: var(--success); }
        
        .cat-content { padding: 15px; display: none; }
        .category.open .cat-content { display: block; }
        .category.open .cat-header { background: var(--primary); color: white; }
        
        .item { background: white; border-radius: 10px; margin-bottom: 10px; border: 2px solid var(--border); }
        .item-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .item-title { display: flex; align-items: center; gap: 8px; font-weight: 600; }
        
        .badge { padding: 3px 8px; border-radius: 15px; font-size: 10px; font-weight: 600; margin-left: 5px; }
        .badge.ai { background: var(--blue-light); color: var(--blue); }
        .badge.webhook { background: var(--success-light); color: var(--success); }
        .badge.static { background: var(--warning-light); color: var(--warning); }
        
        .add-btn { width: 100%; padding: 12px; border: 2px dashed var(--border); border-radius: 10px; background: transparent; color: var(--text-light); font-family: inherit; font-size: 13px; cursor: pointer; }
        .add-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-box { background: white; border-radius: 16px; padding: 25px; width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .close-btn { width: 36px; height: 36px; border: none; border-radius: 8px; background: var(--bg); font-size: 18px; cursor: pointer; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 14px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .type-select { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-option { flex: 1; padding: 15px 10px; border: 2px solid var(--border); border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .type-option:hover { border-color: var(--primary); }
        .type-option.active { border-color: var(--primary); background: var(--primary-light); }
        .type-option span { font-size: 24px; display: block; margin-bottom: 5px; }
        .type-option small { font-size: 11px; color: var(--text-light); }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btns button { flex: 1; padding: 12px; border-radius: 10px; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: var(--bg); color: var(--text); }
        .btn-save { background: var(--success); color: white; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--success); color: white; padding: 12px 25px; border-radius: 10px; font-weight: 600; opacity: 0; transition: 0.3s; z-index: 2000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .loading { text-align: center; padding: 40px; color: var(--text-light); }
        .empty { text-align: center; padding: 40px; color: var(--text-light); }
        .empty span { font-size: 48px; display: block; margin-bottom: 10px; }
        
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main { margin-right: 0; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
        <div class="nav-item active" onclick="showPage('questions')"><span>ğŸ“‚</span> Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
        <div class="nav-item" onclick="showPage('files')"><span>ğŸ“</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</div>
        <div class="nav-item" onclick="showPage('settings')"><span>âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        <div class="nav-item" onclick="window.open('index.html','_blank')"><span>ğŸ‘ï¸</span> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙÙˆØ±Ù…</div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div class="header">
            <div>
                <h1>Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
                <p style="opacity:0.8;font-size:14px;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© Ù…Ø¹ Gemini AI</p>
            </div>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
            </div>
        </div>

        <!-- Questions Page -->
        <div class="page active" id="page-questions">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
                    <button class="btn btn-success" onclick="addCategory()">â• Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <div id="categoriesContent"></div>
            </div>
        </div>

        <!-- Files Page -->
        <div class="page" id="page-files">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</h2>
                </div>
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <span>ğŸ“¤</span>
                    <p>Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
                    <p style="font-size:12px;margin-top:5px;">PDF, Word, Excel, ØµÙˆØ±</p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg">
                </div>
                <div class="files-grid" id="filesGrid"></div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="page-settings">
            <div class="card">
                <div class="card-header">
                    <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                </div>
                <div class="settings-row">
                    <label>ğŸ”‘ Gemini API Key:</label>
                    <input type="password" id="geminiKey" placeholder="AIzaSy...">
                    <button class="btn btn-primary btn-sm" onclick="saveSettings()">Ø­ÙØ¸</button>
                </div>
                <div class="settings-row">
                    <label>ğŸ”— Webhook URL:</label>
                    <input type="text" id="webhookUrl" placeholder="https://hook.eu2.make.com/...">
                    <button class="btn btn-primary btn-sm" onclick="saveSettings()">Ø­ÙØ¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal" id="catModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2 id="catModalTitle">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</h2>
                <button class="close-btn" onclick="closeModal('catModal')">Ã—</button>
            </div>
            <form onsubmit="saveCat(event)">
                <input type="hidden" id="catId">
                <div class="form-group">
                    <label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
                    <input type="text" id="catIcon" placeholder="ğŸ’°" maxlength="2" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ</label>
                        <input type="text" id="catNameAr" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
                        <input type="text" id="catNameEn" required>
                    </div>
                </div>
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" onclick="closeModal('catModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Item Modal -->
    <div class="modal" id="itemModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2 id="itemModalTitle">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h2>
                <button class="close-btn" onclick="closeModal('itemModal')">Ã—</button>
            </div>
            <form onsubmit="saveItem(event)">
                <input type="hidden" id="itemId">
                <input type="hidden" id="itemCatId">
                
                <div class="form-group">
                    <label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
                    <input type="text" id="itemIcon" placeholder="ğŸ“†" maxlength="2" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ø±Ø¨ÙŠ</label>
                        <input type="text" id="itemLabelAr" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
                        <input type="text" id="itemLabelEn" required>
                    </div>
                </div>
                
                <label style="font-weight:600;margin-bottom:10px;display:block;">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</label>
                <div class="type-select">
                    <div class="type-option active" id="typeStatic" onclick="setAnswerType('static')">
                        <span>ğŸ“</span>
                        Ø«Ø§Ø¨ØªØ©
                        <small>ØªÙƒØªØ¨Ù‡Ø§ Ø£Ù†Øª</small>
                    </div>
                    <div class="type-option" id="typeAI" onclick="setAnswerType('ai')">
                        <span>ğŸ¤–</span>
                        AI Ø°ÙƒÙŠ
                        <small>Gemini ÙŠØ¬ÙŠØ¨</small>
                    </div>
                    <div class="type-option" id="typeWebhook" onclick="setAnswerType('webhook')">
                        <span>ğŸ”—</span>
                        Webhook
                        <small>Ø¥Ø±Ø³Ø§Ù„ Ø®Ø§Ø±Ø¬ÙŠ</small>
                    </div>
                </div>
                
                <!-- Static Answer -->
                <div id="staticSection">
                    <div class="form-group">
                        <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ø±Ø¨ÙŠ</label>
                        <textarea id="itemRespAr" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
                        <textarea id="itemRespEn" rows="3"></textarea>
                    </div>
                </div>
                
                <!-- AI Section -->
                <div id="aiSection" style="display:none;">
                    <div class="form-group">
                        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø¨Ø­Ø« ÙÙŠÙ‡</label>
                        <select id="itemFile">
                            <option value="">-- Ø§Ø®ØªØ± Ù…Ù„Ù --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù€ AI (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <textarea id="itemPrompt" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¬Ø¨ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ± ÙˆÙ…Ø¨Ø§Ø´Ø±"></textarea>
                    </div>
                </div>
                
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" onclick="closeModal('itemModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://nrsnsysjmhboovutirdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yc25zeXNqbWhib292dXRpcmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDYxNjYsImV4cCI6MjA4NzE4MjE2Nn0.A6XRe0wUA267hogwWnNpXe08B-MrL1HSjBVbURyLdsU';
        
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let categories = [], items = [], files = [], settings = {};
        let answerType = 'static';

        // Load Data
        async function loadData() {
            try {
                const { data: s } = await db.from('settings').select('*').limit(1).single();
                if (s) {
                    settings = s;
                    document.getElementById('geminiKey').value = s.gemini_key || '';
                    document.getElementById('webhookUrl').value = s.webhook_url || '';
                }
                
                const { data: c } = await db.from('categories').select('*').eq('is_active', true).order('sort_order');
                categories = c || [];
                
                const { data: i } = await db.from('items').select('*').eq('is_active', true).order('sort_order');
                items = i || [];
                
                await loadFiles();
                
                setStatus(true);
                renderCategories();
            } catch (e) {
                console.error(e);
                setStatus(false);
            }
        }

        async function loadFiles() {
            try {
                const { data } = await db.storage.from('files').list();
                files = data || [];
                renderFiles();
                updateFileSelect();
            } catch (e) {
                console.error(e);
            }
        }

        function setStatus(online) {
            document.getElementById('statusDot').className = 'status-dot ' + (online ? 'online' : 'offline');
            document.getElementById('statusText').textContent = online ? 'Ù…ØªØµÙ„ âœ“' : 'ØºÙŠØ± Ù…ØªØµÙ„';
        }

        // Pages
        window.showPage = (page) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
        };

        // Render Categories
        function renderCategories() {
            const el = document.getElementById('categoriesContent');
            if (!categories.length) {
                el.innerHTML = '<div class="empty"><span>ğŸ“­</span><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…</p></div>';
                return;
            }
            el.innerHTML = categories.map(c => {
                const catItems = items.filter(i => i.category_id === c.id);
                return `
                    <div class="category" id="cat_${c.id}">
                        <div class="cat-header" onclick="toggleCat('${c.id}')">
                            <div class="cat-title">
                                <div class="icon">${c.icon}</div>
                                <div>${c.name_ar}</div>
                            </div>
                            <div class="cat-actions" onclick="event.stopPropagation()">
                                <button class="icon-btn add" onclick="addItem('${c.id}')">â•</button>
                                <button class="icon-btn edit" onclick="editCat('${c.id}')">âœï¸</button>
                                <button class="icon-btn delete" onclick="delCat('${c.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="cat-content">
                            ${catItems.map(i => renderItem(i)).join('') || '<p style="color:var(--text-light);text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©</p>'}
                            <button class="add-btn" onclick="addItem('${c.id}')">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderItem(i) {
            let badge = '';
            if (i.answer_type === 'ai') badge = '<span class="badge ai">ğŸ¤– AI</span>';
            else if (i.answer_type === 'webhook') badge = '<span class="badge webhook">ğŸ”— Webhook</span>';
            else badge = '<span class="badge static">ğŸ“ Ø«Ø§Ø¨ØªØ©</span>';
            
            return `
                <div class="item">
                    <div class="item-header">
                        <div class="item-title">
                            <span>${i.icon}</span>
                            <span>${i.label_ar}</span>
                            ${badge}
                        </div>
                        <div>
                            <button class="icon-btn edit" onclick="editItem('${i.id}')">âœï¸</button>
                            <button class="icon-btn delete" onclick="delItem('${i.id}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Files
        function renderFiles() {
            const el = document.getElementById('filesGrid');
            if (!files.length) {
                el.innerHTML = '<div class="empty"><span>ğŸ“­</span><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª</p></div>';
                return;
            }
            el.innerHTML = files.map(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                let icon = 'ğŸ“„';
                if (['pdf'].includes(ext)) icon = 'ğŸ“•';
                else if (['doc', 'docx'].includes(ext)) icon = 'ğŸ“˜';
                else if (['xls', 'xlsx'].includes(ext)) icon = 'ğŸ“—';
                else if (['png', 'jpg', 'jpeg'].includes(ext)) icon = 'ğŸ–¼ï¸';
                
                const size = f.metadata?.size ? (f.metadata.size / 1024).toFixed(1) + ' KB' : '';
                
                return `
                    <div class="file-card">
                        <button class="delete" onclick="deleteFile('${f.name}')">Ã—</button>
                        <div class="icon">${icon}</div>
                        <div class="name">${f.name}</div>
                        <div class="size">${size}</div>
                    </div>
                `;
            }).join('');
        }

        function updateFileSelect() {
            const select = document.getElementById('itemFile');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù„Ù --</option>' + 
                files.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
        }

        // File Upload
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            for (let f of files) await uploadFile(f);
        });

        fileInput.addEventListener('change', async (e) => {
            for (let f of e.target.files) await uploadFile(f);
            fileInput.value = '';
        });

        async function uploadFile(file) {
            try {
                toast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ' + file.name + '...');
                const { error } = await db.storage.from('files').upload(file.name, file, { upsert: true });
                if (error) throw error;
                toast('ØªÙ… Ø±ÙØ¹ ' + file.name + ' âœ…');
                loadFiles();
            } catch (e) {
                toast('Ø®Ø·Ø£: ' + e.message, true);
            }
        }

        window.deleteFile = async (name) => {
            if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØŸ')) return;
            try {
                await db.storage.from('files').remove([name]);
                toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
                loadFiles();
            } catch (e) {
                toast('Ø®Ø·Ø£: ' + e.message, true);
            }
        };

        // Toggle & Modals
        window.toggleCat = (id) => document.getElementById('cat_' + id)?.classList.toggle('open');
        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        // Category CRUD
        window.addCategory = () => {
            document.getElementById('catModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…';
            document.getElementById('catId').value = '';
            document.getElementById('catIcon').value = '';
            document.getElementById('catNameAr').value = '';
            document.getElementById('catNameEn').value = '';
            openModal('catModal');
        };

        window.editCat = (id) => {
            const c = categories.find(x => x.id === id);
            document.getElementById('catModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…';
            document.getElementById('catId').value = id;
            document.getElementById('catIcon').value = c.icon;
            document.getElementById('catNameAr').value = c.name_ar;
            document.getElementById('catNameEn').value = c.name_en;
            openModal('catModal');
        };

        window.saveCat = async (e) => {
            e.preventDefault();
            const id = document.getElementById('catId').value;
            const data = {
                icon: document.getElementById('catIcon').value,
                name_ar: document.getElementById('catNameAr').value,
                name_en: document.getElementById('catNameEn').value
            };
            try {
                if (id) await db.from('categories').update(data).eq('id', id);
                else await db.from('categories').insert({ ...data, sort_order: categories.length });
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
                closeModal('catModal');
                loadData();
            } catch (e) { toast('Ø®Ø·Ø£: ' + e.message, true); }
        };

        window.delCat = async (id) => {
            if (!confirm('Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙˆØ£Ø³Ø¦Ù„ØªÙ‡ØŸ')) return;
            await db.from('categories').update({ is_active: false }).eq('id', id);
            toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            loadData();
        };

        // Item CRUD
        window.setAnswerType = (type) => {
            answerType = type;
            document.querySelectorAll('.type-option').forEach(t => t.classList.remove('active'));
            document.getElementById('type' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
            document.getElementById('staticSection').style.display = type === 'static' ? '' : 'none';
            document.getElementById('aiSection').style.display = type === 'ai' ? '' : 'none';
        };

        window.addItem = (catId) => {
            document.getElementById('itemModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„';
            document.getElementById('itemId').value = '';
            document.getElementById('itemCatId').value = catId;
            document.getElementById('itemIcon').value = '';
            document.getElementById('itemLabelAr').value = '';
            document.getElementById('itemLabelEn').value = '';
            document.getElementById('itemRespAr').value = '';
            document.getElementById('itemRespEn').value = '';
            document.getElementById('itemFile').value = '';
            document.getElementById('itemPrompt').value = '';
            setAnswerType('static');
            openModal('itemModal');
        };

        window.editItem = (id) => {
            const i = items.find(x => x.id === id);
            document.getElementById('itemModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„';
            document.getElementById('itemId').value = id;
            document.getElementById('itemCatId').value = i.category_id;
            document.getElementById('itemIcon').value = i.icon;
            document.getElementById('itemLabelAr').value = i.label_ar;
            document.getElementById('itemLabelEn').value = i.label_en;
            document.getElementById('itemRespAr').value = i.response_ar || '';
            document.getElementById('itemRespEn').value = i.response_en || '';
            document.getElementById('itemFile').value = i.file_name || '';
            document.getElementById('itemPrompt').value = i.ai_prompt || '';
            setAnswerType(i.answer_type || 'static');
            openModal('itemModal');
        };

        window.saveItem = async (e) => {
            e.preventDefault();
            const id = document.getElementById('itemId').value;
            const data = {
                category_id: document.getElementById('itemCatId').value,
                icon: document.getElementById('itemIcon').value,
                label_ar: document.getElementById('itemLabelAr').value,
                label_en: document.getElementById('itemLabelEn').value,
                response_ar: document.getElementById('itemRespAr').value || null,
                response_en: document.getElementById('itemRespEn').value || null,
                answer_type: answerType,
                file_name: document.getElementById('itemFile').value || null,
                ai_prompt: document.getElementById('itemPrompt').value || null
            };
            try {
                if (id) await db.from('items').update(data).eq('id', id);
                else await db.from('items').insert({ ...data, sort_order: items.length });
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
                closeModal('itemModal');
                loadData();
            } catch (e) { toast('Ø®Ø·Ø£: ' + e.message, true); }
        };

        window.delItem = async (id) => {
            if (!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) return;
            await db.from('items').update({ is_active: false }).eq('id', id);
            toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            loadData();
        };

        // Settings
        window.saveSettings = async () => {
            const data = {
                gemini_key: document.getElementById('geminiKey').value,
                webhook_url: document.getElementById('webhookUrl').value
            };
            try {
                if (settings.id) await db.from('settings').update(data).eq('id', settings.id);
                else await db.from('settings').insert(data);
                settings = { ...settings, ...data };
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
            } catch (e) { toast('Ø®Ø·Ø£: ' + e.message, true); }
        };

        // Toast
        function toast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // Close modals
        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
        });

        // Init
        loadData();
    </script>
</body>
</html>
