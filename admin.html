<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù†Ø¸Ø§Ù… Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6366F1; --primary-dark: #4F46E5; --primary-light: #E0E7FF;
            --success: #10B981; --success-light: #D1FAE5;
            --warning: #F59E0B; --warning-light: #FEF3C7;
            --danger: #EF4444; --danger-light: #FEE2E2;
            --purple: #8B5CF6; --purple-light: #EDE9FE;
            --cyan: #06B6D4; --cyan-light: #CFFAFE;
            --gray-50: #F9FAFB; --gray-100: #F3F4F6; --gray-200: #E5E7EB;
            --gray-300: #D1D5DB; --gray-600: #4B5563; --gray-800: #1F2937;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--gray-100); min-height: 100vh; }
        
        /* Header */
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%); padding: 16px 24px; color: white; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(99,102,241,0.3); }
        .header h1 { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 10px; }
        .header-btn { padding: 10px 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 10px; color: white; font-family: inherit; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .header-btn:hover { background: rgba(255,255,255,0.3); }
        .header-btn.primary { background: white; color: var(--primary); }
        
        /* Tabs */
        .tabs-container { background: white; border-bottom: 1px solid var(--gray-200); padding: 0 24px; }
        .tabs { display: flex; gap: 0; }
        .tab { padding: 16px 24px; font-weight: 600; font-size: 14px; color: var(--gray-600); cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .tab:hover { color: var(--primary); background: var(--primary-light); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        /* Main Container */
        .main { padding: 24px; max-width: 1400px; margin: 0 auto; }
        
        /* Cards */
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 20px; overflow: hidden; }
        .card-header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 24px; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-icon { width: 32px; height: 32px; padding: 0; justify-content: center; border-radius: 8px; }
        
        /* ==================== FLOW BUILDER ==================== */
        .flow-container { background: var(--gray-50); border-radius: 12px; min-height: 500px; position: relative; overflow: hidden; }
        .flow-toolbar { padding: 12px 16px; background: white; border-bottom: 1px solid var(--gray-200); display: flex; gap: 10px; align-items: center; }
        .flow-canvas { padding: 24px; min-height: 450px; }
        
        /* Flow Nodes */
        .flow-node { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-right: 4px solid var(--gray-300); position: relative; transition: 0.2s; }
        .flow-node:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .flow-node.section { border-right-color: var(--primary); }
        .flow-node.question { border-right-color: var(--cyan); }
        .flow-node.action { border-right-color: var(--success); }
        
        .flow-node-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .flow-node-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .flow-node.section .flow-node-icon { background: var(--primary-light); }
        .flow-node.question .flow-node-icon { background: var(--cyan-light); }
        .flow-node.action .flow-node-icon { background: var(--success-light); }
        
        .flow-node-info { flex: 1; }
        .flow-node-title { font-weight: 700; font-size: 15px; margin-bottom: 2px; }
        .flow-node-subtitle { font-size: 12px; color: var(--gray-600); }
        .flow-node-number { background: var(--gray-100); color: var(--gray-600); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        
        .flow-node-badges { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .flow-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .flow-badge.var { background: var(--cyan-light); color: var(--cyan); }
        .flow-badge.type { background: var(--purple-light); color: var(--purple); }
        .flow-badge.file { background: var(--success-light); color: var(--success); }
        .flow-badge.condition { background: var(--warning-light); color: var(--warning); }
        
        .flow-node-actions { position: absolute; top: 12px; left: 12px; display: flex; gap: 4px; opacity: 0; transition: 0.2s; }
        .flow-node:hover .flow-node-actions { opacity: 1; }
        .flow-node-actions button { width: 28px; height: 28px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .flow-node-actions .add { background: var(--success-light); color: var(--success); }
        .flow-node-actions .edit { background: var(--warning-light); color: var(--warning); }
        .flow-node-actions .delete { background: var(--danger-light); color: var(--danger); }
        
        .flow-children { margin-right: 32px; padding-right: 16px; border-right: 2px dashed var(--gray-300); margin-top: 12px; }
        
        .flow-add-btn { width: 100%; padding: 16px; border: 2px dashed var(--gray-300); border-radius: 12px; background: transparent; color: var(--gray-600); font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 16px; transition: 0.2s; }
        .flow-add-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        
        /* ==================== FILES ==================== */
        .files-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .file-card { background: var(--gray-50); border-radius: 12px; padding: 16px; position: relative; transition: 0.2s; }
        .file-card:hover { background: var(--gray-100); }
        .file-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .file-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .file-icon.excel { background: #D1FAE5; }
        .file-icon.pdf { background: #FEE2E2; }
        .file-icon.image { background: #DBEAFE; }
        .file-icon.doc { background: #E0E7FF; }
        .file-card-info h3 { font-size: 14px; font-weight: 600; margin-bottom: 2px; word-break: break-all; }
        .file-card-info p { font-size: 12px; color: var(--gray-600); }
        .file-card-meta { font-size: 11px; color: var(--gray-600); margin-bottom: 12px; }
        .file-columns { background: white; border-radius: 8px; padding: 10px; margin-top: 10px; }
        .file-columns-title { font-size: 11px; font-weight: 700; color: var(--gray-600); margin-bottom: 6px; }
        .file-column-tag { display: inline-block; padding: 3px 8px; background: var(--cyan-light); color: var(--cyan); border-radius: 10px; font-size: 10px; font-weight: 600; margin: 2px; }
        .file-card-actions { display: flex; gap: 6px; }
        .file-delete { position: absolute; top: 12px; left: 12px; width: 28px; height: 28px; border: none; border-radius: 50%; background: var(--danger); color: white; cursor: pointer; font-size: 12px; opacity: 0; transition: 0.2s; }
        .file-card:hover .file-delete { opacity: 1; }
        
        .upload-zone { border: 2px dashed var(--gray-300); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: 0.2s; }
        .upload-zone:hover { border-color: var(--primary); background: var(--primary-light); }
        .upload-zone-icon { font-size: 48px; margin-bottom: 12px; }
        .upload-zone input { display: none; }
        
        /* ==================== SETTINGS ==================== */
        .settings-form { max-width: 600px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 16px; border: 2px solid var(--gray-200); border-radius: 10px; font-family: inherit; font-size: 14px; transition: 0.2s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        /* ==================== MODAL ==================== */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-box { background: white; border-radius: 20px; width: 100%; max-width: 560px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 18px; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; border: none; border-radius: 10px; background: var(--gray-100); font-size: 18px; cursor: pointer; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; gap: 12px; justify-content: flex-end; }
        
        /* Node Type Selector */
        .node-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .node-type-btn { padding: 20px 16px; border: 2px solid var(--gray-200); border-radius: 12px; background: white; cursor: pointer; text-align: center; transition: 0.2s; }
        .node-type-btn:hover { border-color: var(--primary); }
        .node-type-btn.active { border-color: var(--primary); background: var(--primary-light); }
        .node-type-btn span { font-size: 28px; display: block; margin-bottom: 8px; }
        .node-type-btn strong { font-size: 14px; display: block; }
        
        /* Action Type Selector */
        .action-types { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 16px; }
        .action-type-btn { padding: 12px 8px; border: 2px solid var(--gray-200); border-radius: 10px; background: white; cursor: pointer; text-align: center; font-size: 11px; transition: 0.2s; }
        .action-type-btn:hover { border-color: var(--primary); }
        .action-type-btn.active { border-color: var(--primary); background: var(--primary-light); }
        .action-type-btn span { font-size: 20px; display: block; margin-bottom: 4px; }
        
        /* Toast */
        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--gray-800); color: white; padding: 14px 28px; border-radius: 12px; font-weight: 600; opacity: 0; transition: 0.3s; z-index: 2000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--gray-600); }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--gray-800); }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›ï¸ Ù†Ø¸Ø§Ù… Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø°ÙƒÙŠ</h1>
        <div class="header-actions">
            <button class="header-btn" onclick="window.open('index.html','_blank')">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
            <button class="header-btn primary" onclick="testSystem()">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±</button>
        </div>
    </div>
    
    <div class="tabs-container">
        <div class="tabs">
            <div class="tab active" onclick="showPage('flow', this)">ğŸ—ºï¸ Ø§Ù„Ù…Ø³Ø§Ø±</div>
            <div class="tab" onclick="showPage('files', this)">ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
            <div class="tab" onclick="showPage('settings', this)">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        </div>
    </div>
    
    <div class="main">
        <!-- Flow Page -->
        <div class="page active" id="page-flow">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ—ºï¸ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
                    <button class="btn btn-success" onclick="openNodeModal(null)">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ</button>
                </div>
                <div class="card-body">
                    <div class="flow-container">
                        <div class="flow-toolbar">
                            <span style="font-size:13px;color:var(--gray-600);">ğŸ“Œ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹</span>
                        </div>
                        <div class="flow-canvas" id="flowCanvas">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Files Page -->
        <div class="page" id="page-files">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</h2>
                </div>
                <div class="card-body">
                    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-zone-icon">ğŸ“¤</div>
                        <p style="font-weight:600;margin-bottom:4px;">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø±ÙØ¹</p>
                        <p style="font-size:13px;color:var(--gray-600);">Excel, PDF, Word, ØµÙˆØ±</p>
                        <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv,.pdf,.doc,.docx,.png,.jpg,.jpeg">
                    </div>
                    <div class="files-grid" id="filesGrid" style="margin-top:24px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Settings Page -->
        <div class="page" id="page-settings">
            <div class="card">
                <div class="card-header">
                    <h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                </div>
                <div class="card-body">
                    <div class="settings-form">
                        <div class="form-group">
                            <label>ğŸ”‘ Gemini API Key</label>
                            <input type="password" id="geminiKey" placeholder="AIzaSy...">
                            <p style="font-size:12px;color:var(--gray-600);margin-top:6px;">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù† <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
                        </div>
                        <div class="form-group">
                            <label>ğŸ”— Webhook URL (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="text" id="webhookUrl" placeholder="https://hook.make.com/...">
                        </div>
                        <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Node Modal -->
    <div class="modal" id="nodeModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2 id="nodeModalTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</h2>
                <button class="modal-close" onclick="closeModal('nodeModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="nodeForm">
                    <input type="hidden" id="nodeId">
                    <input type="hidden" id="nodeParentId">
                    
                    <div class="form-group">
                        <label>ğŸ“ ÙŠØ¶Ø§Ù ØªØ­Øª:</label>
                        <select id="nodeParentSelect" onchange="document.getElementById('nodeParentId').value = this.value">
                            <option value="">ğŸ  Ø§Ù„Ø¬Ø°Ø± (Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ)</option>
                        </select>
                    </div>
                    
                    <label style="font-weight:600;margin-bottom:10px;display:block;">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù†ØµØ±:</label>
                    <div class="node-types">
                        <button type="button" class="node-type-btn active" data-type="section" onclick="setNodeType('section')">
                            <span>ğŸ“‚</span><strong>Ù‚Ø³Ù…</strong>
                        </button>
                        <button type="button" class="node-type-btn" data-type="question" onclick="setNodeType('question')">
                            <span>â“</span><strong>Ø³Ø¤Ø§Ù„</strong>
                        </button>
                        <button type="button" class="node-type-btn" data-type="action" onclick="setNodeType('action')">
                            <span>âš¡</span><strong>Ø£ÙƒØ´Ù†</strong>
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>ğŸ¨ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
                            <input type="text" id="nodeIcon" value="ğŸ“‚" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“Š Ø§Ù„ØªØ±ØªÙŠØ¨</label>
                            <input type="number" id="nodeOrder" value="0" min="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¹Ø±Ø¨ÙŠ) *</label>
                            <input type="text" id="nodeTitleAr" required>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
                            <input type="text" id="nodeTitleEn">
                        </div>
                    </div>
                    
                    <!-- Question Fields -->
                    <div id="questionFields" style="display:none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>ğŸ”¤ Ø§Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ± *</label>
                                <input type="text" id="nodeVarName" placeholder="Ù…Ø«Ø§Ù„: emp_id, name">
                            </div>
                            <div class="form-group">
                                <label>ğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</label>
                                <select id="nodeInputType" onchange="toggleOptionsField()">
                                    <option value="text">Ù†Øµ</option>
                                    <option value="number">Ø±Ù‚Ù…</option>
                                    <option value="select">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</option>
                                    <option value="date">ØªØ§Ø±ÙŠØ®</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" id="optionsField" style="display:none;">
                            <label>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª (JSON)</label>
                            <textarea id="nodeOptions" rows="3" placeholder='[{"value":"hr","label_ar":"Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©"},{"value":"it","label_ar":"ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª"}]'></textarea>
                        </div>
                    </div>
                    
                    <!-- Condition Field -->
                    <div class="form-group" id="conditionField" style="display:none;">
                        <label>ğŸ”— Ø´Ø±Ø· Ø§Ù„Ø¸Ù‡ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="nodeCondition" placeholder='Ù…Ø«Ø§Ù„: {"var":"dept","equals":"hr"}'>
                        <p style="font-size:11px;color:var(--gray-600);margin-top:4px;">ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØ­Ù‚Ù‚ Ø§Ù„Ø´Ø±Ø·</p>
                    </div>
                    
                    <!-- Action Fields -->
                    <div id="actionFields" style="display:none;">
                        <label style="font-weight:600;margin-bottom:10px;display:block;">Ù†ÙˆØ¹ Ø§Ù„Ø£ÙƒØ´Ù†:</label>
                        <div class="action-types">
                            <button type="button" class="action-type-btn active" data-type="file_ai" onclick="setActionType('file_ai')">
                                <span>ğŸ¤–</span>Ù…Ù„Ù + AI
                            </button>
                            <button type="button" class="action-type-btn" data-type="static" onclick="setActionType('static')">
                                <span>ğŸ“</span>Ø±Ø¯ Ø«Ø§Ø¨Øª
                            </button>
                            <button type="button" class="action-type-btn" data-type="phone" onclick="setActionType('phone')">
                                <span>ğŸ“</span>Ø§ØªØµØ§Ù„
                            </button>
                            <button type="button" class="action-type-btn" data-type="whatsapp" onclick="setActionType('whatsapp')">
                                <span>ğŸ’¬</span>ÙˆØ§ØªØ³Ø§Ø¨
                            </button>
                            <button type="button" class="action-type-btn" data-type="webhook" onclick="setActionType('webhook')">
                                <span>ğŸ”—</span>Webhook
                            </button>
                        </div>
                        
                        <div id="fileAiFields">
                            <div class="form-group">
                                <label>ğŸ“ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</label>
                                <select id="nodeFileId"></select>
                            </div>
                        </div>
                        
                        <div id="staticFields" style="display:none;">
                            <div class="form-group">
                                <label>Ø§Ù„Ø±Ø¯ (Ø¹Ø±Ø¨ÙŠ)</label>
                                <textarea id="nodeResponseAr" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Ø§Ù„Ø±Ø¯ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
                                <textarea id="nodeResponseEn" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <div id="phoneFields" style="display:none;">
                            <div class="form-group">
                                <label>ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input type="text" id="nodePhone" placeholder="966501234567">
                            </div>
                        </div>
                        
                        <div id="webhookFields" style="display:none;">
                            <div class="form-group">
                                <label>ğŸ”— Webhook URL</label>
                                <input type="text" id="nodeWebhook" placeholder="https://...">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:var(--gray-200);" onclick="closeModal('nodeModal')">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-success" onclick="saveNode()">ğŸ’¾ Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
    
    <!-- File Edit Modal -->
    <div class="modal" id="fileModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ù</h2>
                <button class="modal-close" onclick="closeModal('fileModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editFileId">
                <div class="form-group">
                    <label>ğŸ“‚ Ø§Ù„ÙÙˆÙ„Ø¯Ø±</label>
                    <input type="text" id="editFileFolderName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±ÙˆØ§ØªØ¨">
                </div>
                <div class="form-group">
                    <label>ğŸ” Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¨Ø­Ø« (Ù„Ù„Ù€ Excel)</label>
                    <input type="text" id="editFileSearchColumns" placeholder="Ù…Ø«Ø§Ù„: emp_id,name">
                    <p style="font-size:11px;color:var(--gray-600);margin-top:4px;">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ÙŠØ¨Ø­Ø« ÙÙŠÙ‡Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                </div>
                <div class="form-group">
                    <label>ğŸ¤– ØªØ¹Ù„ÙŠÙ…Ø§Øª AI</label>
                    <textarea id="editFilePrompt" rows="4" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:var(--gray-200);" onclick="closeModal('fileModal')">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-success" onclick="saveFileSettings()">ğŸ’¾ Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://nrsnsysjmhboovutirdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yc25zeXNqbWhib292dXRpcmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDYxNjYsImV4cCI6MjA4NzE4MjE2Nn0.A6XRe0wUA267hogwWnNpXe08B-MrL1HSjBVbURyLdsU';
        
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let flowNodes = [], files = [], settings = {};
        let nodeType = 'section', actionType = 'file_ai';

        // ==================== LOAD DATA ====================
        async function loadData() {
            try {
                const { data: s } = await db.from('settings').select('*').limit(1).single();
                if (s) {
                    settings = s;
                    document.getElementById('geminiKey').value = s.gemini_key || '';
                    document.getElementById('webhookUrl').value = s.webhook_url || '';
                }
                
                const { data: nodes } = await db.from('flow_nodes').select('*').eq('is_active', true).order('sort_order');
                flowNodes = nodes || [];
                
                const { data: f } = await db.from('files').select('*').eq('is_active', true).order('created_at', { ascending: false });
                files = f || [];
                
                renderFlow();
                renderFiles();
                updateSelects();
            } catch (e) {
                console.error('Load error:', e);
                toast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        // ==================== RENDER FLOW ====================
        function renderFlow() {
            const canvas = document.getElementById('flowCanvas');
            const roots = flowNodes.filter(n => !n.parent_id);
            
            if (!roots.length) {
                canvas.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ—ºï¸</div>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</h3>
                        <p>Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ" Ù„Ù„Ø¨Ø¯Ø¡</p>
                    </div>
                `;
                return;
            }
            
            canvas.innerHTML = roots.map(n => renderNode(n)).join('');
        }

        function renderNode(node, level = 0) {
            const children = flowNodes.filter(n => n.parent_id === node.id);
            const file = node.action_file_id ? files.find(f => f.id === node.action_file_id) : null;
            
            let badges = '';
            if (node.var_name) badges += `<span class="flow-badge var">{${node.var_name}}</span>`;
            if (node.input_type) badges += `<span class="flow-badge type">${node.input_type}</span>`;
            if (file) badges += `<span class="flow-badge file">ğŸ“ ${file.original_name || file.file_name}</span>`;
            if (node.show_condition) badges += `<span class="flow-badge condition">Ø´Ø±Ø·</span>`;
            if (node.action_type && node.node_type === 'action') {
                const typeLabels = { file_ai: 'ğŸ¤– AI', static: 'ğŸ“ Ø«Ø§Ø¨Øª', phone: 'ğŸ“ Ø§ØªØµØ§Ù„', whatsapp: 'ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨', webhook: 'ğŸ”— Webhook' };
                badges += `<span class="flow-badge type">${typeLabels[node.action_type] || node.action_type}</span>`;
            }
            
            const pathNum = node.path_number || '';
            
            return `
                <div class="flow-node ${node.node_type}">
                    <div class="flow-node-actions">
                        ${node.node_type !== 'action' ? `<button class="add" onclick="openNodeModal('${node.id}')" title="Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ÙŠ">â•</button>` : ''}
                        <button class="edit" onclick="editNode('${node.id}')" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                        <button class="delete" onclick="deleteNode('${node.id}')" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                    </div>
                    <div class="flow-node-header">
                        <div class="flow-node-icon">${node.icon}</div>
                        <div class="flow-node-info">
                            <div class="flow-node-title">${node.title_ar}</div>
                            <div class="flow-node-subtitle">${node.title_en || ''}</div>
                        </div>
                        ${pathNum ? `<span class="flow-node-number">${pathNum}</span>` : ''}
                    </div>
                    ${badges ? `<div class="flow-node-badges">${badges}</div>` : ''}
                    ${children.length ? `<div class="flow-children">${children.map(c => renderNode(c, level + 1)).join('')}</div>` : ''}
                </div>
            `;
        }

        // ==================== RENDER FILES ====================
        function renderFiles() {
            const grid = document.getElementById('filesGrid');
            
            if (!files.length) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column:1/-1;">
                        <div class="empty-state-icon">ğŸ“</div>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª</h3>
                        <p>Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Excel Ø£Ùˆ PDF</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = files.map(f => {
                const ext = f.file_name?.split('.').pop()?.toLowerCase() || '';
                let iconClass = 'doc', iconEmoji = 'ğŸ“„';
                if (['xlsx', 'xls', 'csv'].includes(ext)) { iconClass = 'excel'; iconEmoji = 'ğŸ“—'; }
                else if (ext === 'pdf') { iconClass = 'pdf'; iconEmoji = 'ğŸ“•'; }
                else if (['png', 'jpg', 'jpeg'].includes(ext)) { iconClass = 'image'; iconEmoji = 'ğŸ–¼ï¸'; }
                
                let columnsHtml = '';
                if (f.columns_info && Array.isArray(f.columns_info)) {
                    columnsHtml = `
                        <div class="file-columns">
                            <div class="file-columns-title">ğŸ“Š Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:</div>
                            ${f.columns_info.map(c => `<span class="file-column-tag">${c.name || c}</span>`).join('')}
                        </div>
                    `;
                }
                
                return `
                    <div class="file-card">
                        <button class="file-delete" onclick="deleteFile('${f.id}', '${f.file_name}')">Ã—</button>
                        <div class="file-card-header">
                            <div class="file-icon ${iconClass}">${iconEmoji}</div>
                            <div class="file-card-info">
                                <h3>${f.original_name || f.file_name}</h3>
                                <p>ğŸ“‚ ${f.folder_name || 'Ø¹Ø§Ù…'}</p>
                            </div>
                        </div>
                        ${columnsHtml}
                        <div class="file-card-actions" style="margin-top:12px;">
                            <button class="btn btn-sm btn-primary" onclick="editFile('${f.id}')">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== NODE MODAL ====================
        window.openNodeModal = (parentId) => {
            document.getElementById('nodeModalTitle').textContent = parentId ? 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ÙØ±Ø¹ÙŠ' : 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ';
            document.getElementById('nodeId').value = '';
            document.getElementById('nodeParentId').value = parentId || '';
            document.getElementById('nodeIcon').value = parentId ? 'â“' : 'ğŸ“‚';
            document.getElementById('nodeOrder').value = '0';
            document.getElementById('nodeTitleAr').value = '';
            document.getElementById('nodeTitleEn').value = '';
            document.getElementById('nodeVarName').value = '';
            document.getElementById('nodeInputType').value = 'text';
            document.getElementById('nodeOptions').value = '';
            document.getElementById('nodeCondition').value = '';
            document.getElementById('nodeResponseAr').value = '';
            document.getElementById('nodeResponseEn').value = '';
            document.getElementById('nodePhone').value = '';
            document.getElementById('nodeWebhook').value = '';
            document.getElementById('nodeFileId').value = '';
            
            setNodeType(parentId ? 'question' : 'section');
            setActionType('file_ai');
            updateParentSelect(parentId);
            updateFileSelect();
            openModal('nodeModal');
        };

        window.editNode = (id) => {
            const node = flowNodes.find(n => n.id === id);
            if (!node) return;
            
            document.getElementById('nodeModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±';
            document.getElementById('nodeId').value = id;
            document.getElementById('nodeParentId').value = node.parent_id || '';
            document.getElementById('nodeIcon').value = node.icon;
            document.getElementById('nodeOrder').value = node.sort_order || 0;
            document.getElementById('nodeTitleAr').value = node.title_ar;
            document.getElementById('nodeTitleEn').value = node.title_en || '';
            document.getElementById('nodeVarName').value = node.var_name || '';
            document.getElementById('nodeInputType').value = node.input_type || 'text';
            document.getElementById('nodeOptions').value = node.options ? JSON.stringify(node.options) : '';
            document.getElementById('nodeCondition').value = node.show_condition ? JSON.stringify(node.show_condition) : '';
            document.getElementById('nodeFileId').value = node.action_file_id || '';
            
            const actionData = node.action_data || {};
            document.getElementById('nodeResponseAr').value = actionData.response_ar || '';
            document.getElementById('nodeResponseEn').value = actionData.response_en || '';
            document.getElementById('nodePhone').value = actionData.phone || '';
            document.getElementById('nodeWebhook').value = actionData.webhook || '';
            
            setNodeType(node.node_type);
            setActionType(node.action_type || 'file_ai');
            updateParentSelect(node.parent_id, id);
            updateFileSelect();
            openModal('nodeModal');
        };

        window.saveNode = async () => {
            const id = document.getElementById('nodeId').value;
            const parentId = document.getElementById('nodeParentId').value;
            
            // Calculate path number
            let pathNumber = '';
            if (parentId) {
                const siblings = flowNodes.filter(n => n.parent_id === parentId && n.id !== id);
                const parent = flowNodes.find(n => n.id === parentId);
                const parentPath = parent?.path_number || '';
                pathNumber = parentPath ? `${parentPath}.${siblings.length + 1}` : `${siblings.length + 1}`;
            } else {
                const roots = flowNodes.filter(n => !n.parent_id && n.id !== id);
                pathNumber = `${roots.length + 1}`;
            }
            
            let options = null;
            try { options = document.getElementById('nodeOptions').value ? JSON.parse(document.getElementById('nodeOptions').value) : null; } catch (e) {}
            
            let showCondition = null;
            try { showCondition = document.getElementById('nodeCondition').value ? JSON.parse(document.getElementById('nodeCondition').value) : null; } catch (e) {}
            
            const actionData = {};
            if (actionType === 'static') {
                actionData.response_ar = document.getElementById('nodeResponseAr').value;
                actionData.response_en = document.getElementById('nodeResponseEn').value;
            } else if (actionType === 'phone' || actionType === 'whatsapp') {
                actionData.phone = document.getElementById('nodePhone').value;
            } else if (actionType === 'webhook') {
                actionData.webhook = document.getElementById('nodeWebhook').value;
            }
            
            const data = {
                parent_id: parentId || null,
                path_number: pathNumber,
                sort_order: parseInt(document.getElementById('nodeOrder').value) || 0,
                node_type: nodeType,
                icon: document.getElementById('nodeIcon').value,
                title_ar: document.getElementById('nodeTitleAr').value,
                title_en: document.getElementById('nodeTitleEn').value || null,
                var_name: nodeType === 'question' ? document.getElementById('nodeVarName').value : null,
                input_type: nodeType === 'question' ? document.getElementById('nodeInputType').value : null,
                options: options,
                show_condition: showCondition,
                action_type: nodeType === 'action' ? actionType : null,
                action_file_id: (nodeType === 'action' && actionType === 'file_ai') ? (document.getElementById('nodeFileId').value || null) : null,
                action_data: Object.keys(actionData).length ? actionData : null
            };
            
            try {
                if (id) {
                    await db.from('flow_nodes').update(data).eq('id', id);
                } else {
                    await db.from('flow_nodes').insert(data);
                }
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
                closeModal('nodeModal');
                loadData();
            } catch (e) {
                console.error('Save error:', e);
                toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error');
            }
        };

        window.deleteNode = async (id) => {
            if (!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± ÙˆÙƒÙ„ ÙØ±ÙˆØ¹Ù‡ØŸ')) return;
            try {
                await db.from('flow_nodes').update({ is_active: false }).eq('id', id);
                toast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
                loadData();
            } catch (e) {
                toast('Ø®Ø·Ø£', 'error');
            }
        };

        window.setNodeType = (type) => {
            nodeType = type;
            document.querySelectorAll('.node-type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === type));
            document.getElementById('questionFields').style.display = type === 'question' ? '' : 'none';
            document.getElementById('actionFields').style.display = type === 'action' ? '' : 'none';
            document.getElementById('conditionField').style.display = type !== 'section' ? '' : 'none';
            
            // Update icon
            const icons = { section: 'ğŸ“‚', question: 'â“', action: 'âš¡' };
            document.getElementById('nodeIcon').value = icons[type];
        };

        window.setActionType = (type) => {
            actionType = type;
            document.querySelectorAll('.action-type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === type));
            document.getElementById('fileAiFields').style.display = type === 'file_ai' ? '' : 'none';
            document.getElementById('staticFields').style.display = type === 'static' ? '' : 'none';
            document.getElementById('phoneFields').style.display = (type === 'phone' || type === 'whatsapp') ? '' : 'none';
            document.getElementById('webhookFields').style.display = type === 'webhook' ? '' : 'none';
        };

        window.toggleOptionsField = () => {
            document.getElementById('optionsField').style.display = document.getElementById('nodeInputType').value === 'select' ? '' : 'none';
        };

        function updateParentSelect(selectedId, excludeId) {
            let options = '<option value="">ğŸ  Ø§Ù„Ø¬Ø°Ø± (Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ)</option>';
            
            const addOptions = (nodes, level = 0) => {
                nodes.forEach(n => {
                    if (n.id !== excludeId && n.node_type !== 'action') {
                        const prefix = 'â€”'.repeat(level);
                        const selected = n.id === selectedId ? 'selected' : '';
                        options += `<option value="${n.id}" ${selected}>${prefix} ${n.icon} ${n.title_ar} ${n.path_number ? `(${n.path_number})` : ''}</option>`;
                        addOptions(flowNodes.filter(c => c.parent_id === n.id), level + 1);
                    }
                });
            };
            
            addOptions(flowNodes.filter(n => !n.parent_id));
            document.getElementById('nodeParentSelect').innerHTML = options;
        }

        function updateFileSelect() {
            let options = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù„Ù --</option>';
            files.forEach(f => {
                options += `<option value="${f.id}">${f.icon || 'ğŸ“„'} ${f.original_name || f.file_name} (${f.folder_name || 'Ø¹Ø§Ù…'})</option>`;
            });
            document.getElementById('nodeFileId').innerHTML = options;
        }

        function updateSelects() {
            updateFileSelect();
        }

        // ==================== FILES ====================
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            for (const file of e.target.files) {
                await uploadFile(file);
            }
            e.target.value = '';
        });

        async function uploadFile(file) {
            toast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ' + file.name + '...', 'info');
            
            try {
                const fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                const ext = file.name.split('.').pop().toLowerCase();
                let fileType = 'doc';
                if (['xlsx', 'xls', 'csv'].includes(ext)) fileType = 'excel';
                else if (ext === 'pdf') fileType = 'pdf';
                else if (['png', 'jpg', 'jpeg'].includes(ext)) fileType = 'image';
                
                // Upload to storage
                const { error: uploadError } = await db.storage.from('files').upload(fileName, file, { upsert: true });
                if (uploadError) throw uploadError;
                
                // Read Excel columns
                let columnsInfo = null;
                if (fileType === 'excel') {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer);
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        if (jsonData.length > 0) {
                            columnsInfo = jsonData[0].map(col => ({ name: col, type: 'text' }));
                        }
                    } catch (e) {
                        console.error('Excel parse error:', e);
                    }
                }
                
                // Save to database
                const fileData = {
                    file_name: fileName,
                    original_name: file.name,
                    file_type: fileType,
                    file_size: file.size,
                    columns_info: columnsInfo,
                    folder_name: 'Ø¹Ø§Ù…'
                };
                
                await db.from('files').insert(fileData);
                toast('ØªÙ… Ø±ÙØ¹ ' + file.name + ' âœ…', 'success');
                loadData();
            } catch (e) {
                console.error('Upload error:', e);
                toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹: ' + e.message, 'error');
            }
        }

        window.editFile = (id) => {
            const file = files.find(f => f.id === id);
            if (!file) return;
            
            document.getElementById('editFileId').value = id;
            document.getElementById('editFileFolderName').value = file.folder_name || '';
            document.getElementById('editFileSearchColumns').value = file.search_columns?.join(',') || '';
            document.getElementById('editFilePrompt').value = file.ai_prompt || '';
            openModal('fileModal');
        };

        window.saveFileSettings = async () => {
            const id = document.getElementById('editFileId').value;
            const searchColumnsStr = document.getElementById('editFileSearchColumns').value;
            
            const data = {
                folder_name: document.getElementById('editFileFolderName').value || 'Ø¹Ø§Ù…',
                search_columns: searchColumnsStr ? searchColumnsStr.split(',').map(s => s.trim()) : null,
                ai_prompt: document.getElementById('editFilePrompt').value || null
            };
            
            try {
                await db.from('files').update(data).eq('id', id);
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…', 'success');
                closeModal('fileModal');
                loadData();
            } catch (e) {
                toast('Ø®Ø·Ø£', 'error');
            }
        };

        window.deleteFile = async (id, fileName) => {
            if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØŸ')) return;
            try {
                await db.storage.from('files').remove([fileName]);
                await db.from('files').update({ is_active: false }).eq('id', id);
                toast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
                loadData();
            } catch (e) {
                toast('Ø®Ø·Ø£', 'error');
            }
        };

        // ==================== SETTINGS ====================
        window.saveSettings = async () => {
            const data = {
                gemini_key: document.getElementById('geminiKey').value,
                webhook_url: document.getElementById('webhookUrl').value
            };
            
            try {
                if (settings.id) {
                    await db.from('settings').update(data).eq('id', settings.id);
                } else {
                    await db.from('settings').insert(data);
                }
                settings = { ...settings, ...data };
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…', 'success');
            } catch (e) {
                toast('Ø®Ø·Ø£', 'error');
            }
        };

        // ==================== HELPERS ====================
        window.showPage = (page, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            el.classList.add('active');
        };

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        window.closeModal = (id) => {
            document.getElementById(id).classList.remove('active');
        };

        function toast(msg, type = 'info') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show ' + type;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        window.testSystem = () => {
            window.open('index.html', '_blank');
        };

        // Close modals on backdrop click
        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); });
        });

        // Load data on start
        loadData();
    </script>
</body>
</html>
