<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5; --primary-light: #EEF2FF;
            --success: #10B981; --success-light: #D1FAE5;
            --warning: #F59E0B; --warning-light: #FEF3C7;
            --danger: #EF4444; --danger-light: #FEE2E2;
            --purple: #8B5CF6; --purple-light: #EDE9FE;
            --blue: #3B82F6; --blue-light: #DBEAFE;
            --cyan: #06B6D4; --cyan-light: #CFFAFE;
            --bg: #F1F5F9; --card: #FFFFFF;
            --text: #1E293B; --text-light: #64748B; --border: #E2E8F0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); min-height: 100vh; }
        
        .sidebar { position: fixed; top: 0; right: 0; width: 220px; height: 100vh; background: var(--card); border-left: 1px solid var(--border); padding: 15px; overflow-y: auto; }
        .logo { font-size: 16px; font-weight: 700; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .nav-item { padding: 10px 12px; border-radius: 8px; margin-bottom: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text-light); font-weight: 500; transition: 0.2s; font-size: 13px; }
        .nav-item:hover, .nav-item.active { background: var(--primary-light); color: var(--primary); }
        
        .main { margin-right: 220px; padding: 15px; }
        
        .header { background: linear-gradient(135deg, var(--primary), #7C3AED); color: white; padding: 18px 20px; border-radius: 14px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 18px; }
        .status { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px; font-size: 11px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #34D399; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 8px; font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 11px; }
        
        .card { background: var(--card); border-radius: 14px; padding: 15px; margin-bottom: 15px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid var(--border); }
        .card-header h2 { font-size: 15px; display: flex; align-items: center; gap: 8px; }
        
        /* Tree */
        .tree-node { margin-bottom: 6px; }
        .node-row { display: flex; align-items: center; gap: 6px; padding: 10px 12px; background: var(--bg); border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .node-row:hover { background: var(--primary-light); }
        .node-icon { font-size: 18px; }
        .node-label { flex: 1; font-weight: 600; }
        .node-badge { padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: 600; }
        .node-badge.branch { background: var(--purple-light); color: var(--purple); }
        .node-badge.question { background: var(--cyan-light); color: var(--cyan); }
        .node-badge.endpoint { background: var(--success-light); color: var(--success); }
        .node-actions button { width: 24px; height: 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 11px; margin-left: 3px; }
        .node-actions .add { background: var(--success-light); color: var(--success); }
        .node-actions .edit { background: var(--warning-light); color: var(--warning); }
        .node-actions .delete { background: var(--danger-light); color: var(--danger); }
        .node-children { margin-right: 20px; padding-right: 12px; border-right: 2px solid var(--border); margin-top: 6px; }
        
        .add-root-btn { width: 100%; padding: 12px; border: 2px dashed var(--border); border-radius: 10px; background: transparent; color: var(--text-light); font-family: inherit; font-size: 13px; cursor: pointer; margin-top: 10px; }
        .add-root-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        
        /* Settings */
        .settings-row { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
        .settings-row label { font-weight: 600; min-width: 110px; font-size: 13px; }
        .settings-row input { flex: 1; min-width: 180px; padding: 8px 10px; border: 2px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 12px; }
        
        /* Files */
        .upload-zone { border: 2px dashed var(--border); border-radius: 10px; padding: 25px; text-align: center; cursor: pointer; }
        .upload-zone:hover { border-color: var(--primary); background: var(--primary-light); }
        .upload-zone span { font-size: 32px; }
        .upload-zone input { display: none; }
        .files-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 12px; }
        .file-card { background: var(--bg); border-radius: 8px; padding: 10px; text-align: center; position: relative; }
        .file-card .icon { font-size: 28px; }
        .file-card .name { font-size: 10px; font-weight: 600; word-break: break-all; margin-top: 5px; }
        .file-card .delete { position: absolute; top: 5px; left: 5px; width: 20px; height: 20px; border-radius: 50%; background: var(--danger); color: white; border: none; cursor: pointer; font-size: 10px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 15px; }
        .modal.active { display: flex; }
        .modal-box { background: white; border-radius: 14px; padding: 20px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h2 { font-size: 16px; }
        .close-btn { width: 30px; height: 30px; border: none; border-radius: 6px; background: var(--bg); font-size: 14px; cursor: pointer; }
        
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 9px 11px; border: 2px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 12px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .type-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
        .type-card { padding: 12px 8px; border: 2px solid var(--border); border-radius: 8px; text-align: center; cursor: pointer; font-size: 11px; }
        .type-card:hover { border-color: var(--primary); }
        .type-card.active { border-color: var(--primary); background: var(--primary-light); }
        .type-card span { font-size: 20px; display: block; margin-bottom: 3px; }
        
        .endpoint-types { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 12px; }
        .ep-type { padding: 8px 4px; border: 2px solid var(--border); border-radius: 6px; text-align: center; cursor: pointer; font-size: 10px; }
        .ep-type:hover { border-color: var(--primary); }
        .ep-type.active { border-color: var(--primary); background: var(--primary-light); }
        .ep-type span { font-size: 16px; display: block; margin-bottom: 2px; }
        
        .question-types { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px; }
        .q-type { padding: 8px; border: 2px solid var(--border); border-radius: 6px; text-align: center; cursor: pointer; font-size: 10px; }
        .q-type:hover { border-color: var(--cyan); }
        .q-type.active { border-color: var(--cyan); background: var(--cyan-light); }
        
        .files-select { display: flex; flex-wrap: wrap; gap: 6px; padding: 10px; background: var(--bg); border-radius: 8px; min-height: 50px; }
        .file-tag { display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--primary-light); color: var(--primary); border-radius: 15px; font-size: 11px; font-weight: 600; }
        .file-tag button { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 12px; }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btns button { flex: 1; padding: 10px; border-radius: 8px; font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: var(--bg); color: var(--text); }
        .btn-save { background: var(--success); color: white; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--success); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; opacity: 0; transition: 0.3s; z-index: 2000; font-size: 13px; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); }
        
        .page { display: none; }
        .page.active { display: block; }
        .empty { text-align: center; padding: 30px; color: var(--text-light); }
        .empty span { font-size: 40px; display: block; margin-bottom: 8px; }
        
        .section-title { font-size: 12px; font-weight: 600; color: var(--text-light); margin: 15px 0 8px; padding-top: 10px; border-top: 1px solid var(--border); }
        
        @media (max-width: 768px) { .sidebar { display: none; } .main { margin-right: 0; } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">ğŸ§  Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ</div>
        <div class="nav-item active" onclick="showPage('tree', this)">ğŸ“‚ Ø§Ù„Ø´Ø¬Ø±Ø©</div>
        <div class="nav-item" onclick="showPage('files', this)">ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
        <div class="nav-item" onclick="showPage('settings', this)">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        <div class="nav-item" onclick="window.open('index.html','_blank')">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
    </div>

    <div class="main">
        <div class="header">
            <div>
                <h1>ğŸ§  Ù†Ø¸Ø§Ù… Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø°ÙƒÙŠ</h1>
                <p style="opacity:0.8;font-size:11px;">Ø£Ø³Ø¦Ù„Ø© + ÙÙ„ØªØ±Ø© + AI + Ù…Ù„ÙØ§Øª</p>
            </div>
            <div class="status"><span class="status-dot" id="statusDot"></span><span id="statusText">Ù…ØªØµÙ„</span></div>
        </div>

        <!-- Tree Page -->
        <div class="page active" id="page-tree">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“‚ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø´Ø¬Ø±Ø©</h2>
                    <div style="font-size:10px;color:var(--text-light);">ğŸ“‚ ÙØ±Ø¹ | â“ Ø³Ø¤Ø§Ù„ | ğŸ Ù†Ù‡Ø§ÙŠØ©</div>
                </div>
                <div id="treeContainer"></div>
                <button class="add-root-btn" onclick="addNode(null)">â• Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>

        <!-- Files Page -->
        <div class="page" id="page-files">
            <div class="card">
                <div class="card-header"><h2>ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª</h2></div>
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <span>ğŸ“¤</span>
                    <p style="font-size:12px;color:var(--text-light);">Ø§Ø³Ø­Ø¨ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ù…Ù„ÙØ§Øª</p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.png,.jpg,.jpeg">
                </div>
                <div class="files-grid" id="filesGrid"></div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="page-settings">
            <div class="card">
                <div class="card-header"><h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2></div>
                <div class="settings-row">
                    <label>ğŸ”‘ Gemini API:</label>
                    <input type="password" id="geminiKey" placeholder="AIzaSy...">
                    <button class="btn btn-primary btn-sm" onclick="saveSettings()">Ø­ÙØ¸</button>
                </div>
                <div class="settings-row">
                    <label>ğŸ”— Webhook:</label>
                    <input type="text" id="webhookUrl" placeholder="https://...">
                    <button class="btn btn-primary btn-sm" onclick="saveSettings()">Ø­ÙØ¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Node Modal -->
    <div class="modal" id="nodeModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2 id="nodeModalTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</h2>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <form onsubmit="saveNode(event)">
                <input type="hidden" id="nodeId">
                <input type="hidden" id="nodeParentId">
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
                        <input type="text" id="nodeIcon" placeholder="ğŸ“" maxlength="2" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ</label>
                        <input type="text" id="nodeLabelAr" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
                        <input type="text" id="nodeLabelEn" required>
                    </div>
                </div>
                
                <label style="font-weight:600;font-size:12px;margin-bottom:6px;display:block;">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù†ØµØ±:</label>
                <div class="type-cards">
                    <div class="type-card active" id="typeBranch" onclick="setNodeType('branch')">
                        <span>ğŸ“‚</span>ÙØ±Ø¹
                    </div>
                    <div class="type-card" id="typeQuestion" onclick="setNodeType('question')">
                        <span>â“</span>Ø³Ø¤Ø§Ù„
                    </div>
                    <div class="type-card" id="typeEndpoint" onclick="setNodeType('endpoint')">
                        <span>ğŸ</span>Ù†Ù‡Ø§ÙŠØ©
                    </div>
                </div>
                
                <!-- Question Section -->
                <div id="questionSection" style="display:none;">
                    <div class="section-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ± (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
                            <input type="text" id="questionKey" placeholder="name, emp_id, month">
                        </div>
                        <div class="form-group">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</label>
                            <select id="questionType">
                                <option value="text">Ù†Øµ</option>
                                <option value="number">Ø±Ù‚Ù…</option>
                                <option value="select">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</option>
                                <option value="date">ØªØ§Ø±ÙŠØ®</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="optionsGroup" style="display:none;">
                        <label>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø§Ø®ØªÙŠØ§Ø±)</label>
                        <textarea id="questionOptions" rows="3" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ&#10;Ø±Ø§ØªØ¨ Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚&#10;ÙƒØ´Ù Ø­Ø³Ø§Ø¨"></textarea>
                    </div>
                </div>
                
                <!-- Endpoint Section -->
                <div id="endpointSection" style="display:none;">
                    <div class="section-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</div>
                    <div class="endpoint-types">
                        <div class="ep-type active" data-type="ai" onclick="setEndpointType('ai')"><span>ğŸ¤–</span>AI</div>
                        <div class="ep-type" data-type="static" onclick="setEndpointType('static')"><span>ğŸ“</span>Ø«Ø§Ø¨ØªØ©</div>
                        <div class="ep-type" data-type="phone" onclick="setEndpointType('phone')"><span>ğŸ“</span>Ø§ØªØµØ§Ù„</div>
                        <div class="ep-type" data-type="whatsapp" onclick="setEndpointType('whatsapp')"><span>ğŸ’¬</span>ÙˆØ§ØªØ³Ø§Ø¨</div>
                        <div class="ep-type" data-type="webhook" onclick="setEndpointType('webhook')"><span>ğŸ”—</span>Webhook</div>
                    </div>
                    
                    <div id="aiFields">
                        <div class="form-group">
                            <label>ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (AI ÙŠØ¨Ø­Ø« ÙÙŠÙ‡Ø§)</label>
                            <select id="fileSelect" onchange="addFileToNode()">
                                <option value="">-- Ø§Ø®ØªØ± Ù…Ù„Ù --</option>
                            </select>
                            <div class="files-select" id="selectedFiles"></div>
                        </div>
                        <div class="form-group">
                            <label>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ù€ AI</label>
                            <textarea id="nodePrompt" rows="2" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ"></textarea>
                        </div>
                    </div>
                    
                    <div id="staticFields" style="display:none;">
                        <div class="form-group">
                            <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ø±Ø¨ÙŠ</label>
                            <textarea id="nodeRespAr" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
                            <textarea id="nodeRespEn" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <div id="phoneFields" style="display:none;">
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø©)</label>
                            <input type="text" id="nodePhone" placeholder="966501234567">
                        </div>
                    </div>
                </div>
                
                <div class="modal-btns">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://nrsnsysjmhboovutirdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yc25zeXNqbWhib292dXRpcmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDYxNjYsImV4cCI6MjA4NzE4MjE2Nn0.A6XRe0wUA267hogwWnNpXe08B-MrL1HSjBVbURyLdsU';
        
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let nodes = [], files = [], settings = {};
        let nodeType = 'branch', endpointType = 'ai';
        let selectedNodeFiles = [];

        async function loadData() {
            try {
                const { data: s } = await db.from('settings').select('*').limit(1).single();
                if (s) {
                    settings = s;
                    document.getElementById('geminiKey').value = s.gemini_key || '';
                    document.getElementById('webhookUrl').value = s.webhook_url || '';
                }
                
                const { data: n } = await db.from('nodes').select('*').eq('is_active', true).order('sort_order');
                nodes = n || [];
                
                await loadFiles();
                renderTree();
                document.getElementById('statusDot').style.background = '#34D399';
            } catch (e) {
                console.error(e);
                document.getElementById('statusDot').style.background = '#F87171';
            }
        }

        async function loadFiles() {
            const { data } = await db.storage.from('files').list();
            files = data || [];
            renderFiles();
            updateFileSelect();
        }

        function renderTree() {
            const container = document.getElementById('treeContainer');
            const rootNodes = nodes.filter(n => !n.parent_id);
            if (!rootNodes.length) {
                container.innerHTML = '<div class="empty"><span>ğŸ“­</span><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</p></div>';
                return;
            }
            container.innerHTML = rootNodes.map(n => renderNode(n)).join('');
        }

        function renderNode(node) {
            const children = nodes.filter(n => n.parent_id === node.id);
            let badgeClass = 'branch', badgeText = 'ğŸ“‚ ÙØ±Ø¹';
            
            if (node.is_question) {
                badgeClass = 'question';
                badgeText = 'â“ Ø³Ø¤Ø§Ù„';
            } else if (node.node_type === 'endpoint') {
                badgeClass = 'endpoint';
                badgeText = getEndpointLabel(node.endpoint_type);
            }
            
            return `
                <div class="tree-node">
                    <div class="node-row">
                        <span class="node-icon">${node.icon}</span>
                        <span class="node-label">${node.label_ar}</span>
                        <span class="node-badge ${badgeClass}">${badgeText}</span>
                        <div class="node-actions">
                            ${node.node_type !== 'endpoint' ? `<button class="add" onclick="addNode('${node.id}')">â•</button>` : ''}
                            <button class="edit" onclick="editNode('${node.id}')">âœï¸</button>
                            <button class="delete" onclick="deleteNode('${node.id}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    ${children.length ? `<div class="node-children">${children.map(c => renderNode(c)).join('')}</div>` : ''}
                </div>
            `;
        }

        function getEndpointLabel(type) {
            const labels = { ai: 'ğŸ¤– AI', static: 'ğŸ“ Ø«Ø§Ø¨ØªØ©', phone: 'ğŸ“ Ø§ØªØµØ§Ù„', whatsapp: 'ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨', webhook: 'ğŸ”— Webhook' };
            return labels[type] || 'ğŸ¤– AI';
        }

        window.showPage = (page, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            el.classList.add('active');
        };

        window.addNode = (parentId) => {
            document.getElementById('nodeModalTitle').textContent = parentId ? 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ÙØ±Ø¹ÙŠ' : 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ';
            document.getElementById('nodeId').value = '';
            document.getElementById('nodeParentId').value = parentId || '';
            document.getElementById('nodeIcon').value = '';
            document.getElementById('nodeLabelAr').value = '';
            document.getElementById('nodeLabelEn').value = '';
            document.getElementById('questionKey').value = '';
            document.getElementById('questionType').value = 'text';
            document.getElementById('questionOptions').value = '';
            document.getElementById('nodeRespAr').value = '';
            document.getElementById('nodeRespEn').value = '';
            document.getElementById('nodePhone').value = '';
            document.getElementById('nodePrompt').value = '';
            selectedNodeFiles = [];
            renderSelectedFiles();
            setNodeType('branch');
            setEndpointType('ai');
            openModal();
        };

        window.editNode = (id) => {
            const node = nodes.find(n => n.id === id);
            if (!node) return;
            
            document.getElementById('nodeModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±';
            document.getElementById('nodeId').value = id;
            document.getElementById('nodeParentId').value = node.parent_id || '';
            document.getElementById('nodeIcon').value = node.icon;
            document.getElementById('nodeLabelAr').value = node.label_ar;
            document.getElementById('nodeLabelEn').value = node.label_en;
            document.getElementById('questionKey').value = node.question_key || '';
            document.getElementById('questionType').value = node.question_type || 'text';
            document.getElementById('questionOptions').value = node.question_options || '';
            document.getElementById('nodeRespAr').value = node.response_ar || '';
            document.getElementById('nodeRespEn').value = node.response_en || '';
            document.getElementById('nodePhone').value = node.phone_number || '';
            document.getElementById('nodePrompt').value = node.ai_prompt || '';
            selectedNodeFiles = node.files || [];
            renderSelectedFiles();
            
            if (node.is_question) setNodeType('question');
            else if (node.node_type === 'endpoint') setNodeType('endpoint');
            else setNodeType('branch');
            
            setEndpointType(node.endpoint_type || 'ai');
            openModal();
        };

        window.saveNode = async (e) => {
            e.preventDefault();
            const id = document.getElementById('nodeId').value;
            const parentId = document.getElementById('nodeParentId').value;
            
            const data = {
                parent_id: parentId || null,
                icon: document.getElementById('nodeIcon').value,
                label_ar: document.getElementById('nodeLabelAr').value,
                label_en: document.getElementById('nodeLabelEn').value,
                node_type: nodeType === 'endpoint' ? 'endpoint' : 'branch',
                is_question: nodeType === 'question',
                question_key: nodeType === 'question' ? document.getElementById('questionKey').value : null,
                question_type: nodeType === 'question' ? document.getElementById('questionType').value : null,
                question_options: nodeType === 'question' ? document.getElementById('questionOptions').value : null,
                endpoint_type: nodeType === 'endpoint' ? endpointType : null,
                response_ar: document.getElementById('nodeRespAr').value || null,
                response_en: document.getElementById('nodeRespEn').value || null,
                phone_number: document.getElementById('nodePhone').value || null,
                ai_prompt: document.getElementById('nodePrompt').value || null,
                files: selectedNodeFiles.length ? selectedNodeFiles : null
            };
            
            try {
                if (id) await db.from('nodes').update(data).eq('id', id);
                else await db.from('nodes').insert(data);
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
                closeModal();
                loadData();
            } catch (e) { toast('Ø®Ø·Ø£: ' + e.message, true); }
        };

        window.deleteNode = async (id) => {
            if (!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) return;
            await db.from('nodes').update({ is_active: false }).eq('id', id);
            toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            loadData();
        };

        window.setNodeType = (type) => {
            nodeType = type;
            document.querySelectorAll('.type-card').forEach(c => c.classList.remove('active'));
            document.getElementById('type' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
            document.getElementById('questionSection').style.display = type === 'question' ? '' : 'none';
            document.getElementById('endpointSection').style.display = type === 'endpoint' ? '' : 'none';
        };

        window.setEndpointType = (type) => {
            endpointType = type;
            document.querySelectorAll('.ep-type').forEach(el => el.classList.toggle('active', el.dataset.type === type));
            document.getElementById('aiFields').style.display = type === 'ai' ? '' : 'none';
            document.getElementById('staticFields').style.display = type === 'static' ? '' : 'none';
            document.getElementById('phoneFields').style.display = (type === 'phone' || type === 'whatsapp') ? '' : 'none';
        };

        document.getElementById('questionType').addEventListener('change', (e) => {
            document.getElementById('optionsGroup').style.display = e.target.value === 'select' ? '' : 'none';
        });

        window.addFileToNode = () => {
            const select = document.getElementById('fileSelect');
            const file = select.value;
            if (file && !selectedNodeFiles.includes(file)) {
                selectedNodeFiles.push(file);
                renderSelectedFiles();
            }
            select.value = '';
        };

        window.removeFileFromNode = (file) => {
            selectedNodeFiles = selectedNodeFiles.filter(f => f !== file);
            renderSelectedFiles();
        };

        function renderSelectedFiles() {
            const container = document.getElementById('selectedFiles');
            if (!selectedNodeFiles.length) {
                container.innerHTML = '<span style="color:var(--text-light);font-size:11px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø±ØªØ¨Ø·Ø©</span>';
                return;
            }
            container.innerHTML = selectedNodeFiles.map(f => `
                <div class="file-tag">${f}<button onclick="removeFileFromNode('${f}')">Ã—</button></div>
            `).join('');
        }

        function openModal() { document.getElementById('nodeModal').classList.add('active'); }
        window.closeModal = () => document.getElementById('nodeModal').classList.remove('active');

        // Files
        function renderFiles() {
            const el = document.getElementById('filesGrid');
            if (!files.length) { el.innerHTML = '<div class="empty"><span>ğŸ“­</span></div>'; return; }
            el.innerHTML = files.map(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                let icon = 'ğŸ“„';
                if (ext === 'pdf') icon = 'ğŸ“•';
                else if (['doc','docx'].includes(ext)) icon = 'ğŸ“˜';
                else if (['xls','xlsx','csv'].includes(ext)) icon = 'ğŸ“—';
                else if (['png','jpg','jpeg'].includes(ext)) icon = 'ğŸ–¼ï¸';
                return `<div class="file-card"><button class="delete" onclick="deleteFile('${f.name}')">Ã—</button><div class="icon">${icon}</div><div class="name">${f.name}</div></div>`;
            }).join('');
        }

        function updateFileSelect() {
            const select = document.getElementById('fileSelect');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù„Ù --</option>' + files.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            for (const f of e.target.files) {
                toast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ' + f.name);
                try {
                    await db.storage.from('files').upload(f.name, f, { upsert: true });
                    toast('ØªÙ… âœ…');
                } catch (err) { toast('Ø®Ø·Ø£', true); }
            }
            e.target.value = '';
            loadFiles();
        });

        window.deleteFile = async (name) => {
            if (!confirm('Ø­Ø°ÙØŸ')) return;
            await db.storage.from('files').remove([name]);
            toast('ØªÙ…');
            loadFiles();
        };

        window.saveSettings = async () => {
            const data = { gemini_key: document.getElementById('geminiKey').value, webhook_url: document.getElementById('webhookUrl').value };
            try {
                if (settings.id) await db.from('settings').update(data).eq('id', settings.id);
                else await db.from('settings').insert(data);
                settings = { ...settings, ...data };
                toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
            } catch (e) { toast('Ø®Ø·Ø£', true); }
        };

        function toast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        document.getElementById('nodeModal').addEventListener('click', e => { if (e.target.id === 'nodeModal') closeModal(); });
        loadData();
    </script>
</body>
</html>
