<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1; --primary-light: #EEF2FF;
            --success: #10B981; --success-light: #D1FAE5;
            --warning: #F59E0B; --warning-light: #FEF3C7;
            --danger: #EF4444; --danger-light: #FEE2E2;
            --purple: #8B5CF6; --purple-light: #EDE9FE;
            --cyan: #06B6D4; --cyan-light: #CFFAFE;
            --bg: #F8FAFC; --card: #FFFFFF;
            --text: #1E293B; --text-light: #64748B; --border: #E2E8F0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, var(--primary), #8B5CF6); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .header-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; font-family: inherit; font-size: 13px; cursor: pointer; }
        
        .container { max-width: 1300px; margin: 0 auto; padding: 20px; }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: var(--card); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .tab:hover { border-color: var(--primary); }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .card-header h2 { font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 8px; font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        .folders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .folder-card { background: var(--bg); border-radius: 12px; overflow: hidden; }
        .folder-header { padding: 12px 15px; background: var(--primary-light); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .folder-header:hover { background: #E0E7FF; }
        .folder-header .icon { font-size: 20px; }
        .folder-header .name { flex: 1; font-weight: 700; font-size: 14px; }
        .folder-header .count { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .folder-actions button { width: 26px; height: 26px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; margin-left: 3px; }
        .folder-actions .edit { background: var(--warning-light); color: var(--warning); }
        .folder-actions .delete { background: var(--danger-light); color: var(--danger); }
        .folder-content { padding: 10px; display: none; }
        .folder-card.open .folder-content { display: block; }
        
        .action-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: white; border-radius: 8px; margin-bottom: 6px; }
        .action-item .icon { font-size: 18px; }
        .action-item .info { flex: 1; }
        .action-item .info .name { font-weight: 600; font-size: 13px; }
        .action-item .info .type { font-size: 10px; color: var(--text-light); }
        .action-item .actions button { width: 24px; height: 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 10px; margin-left: 3px; }
        .action-item .actions .edit { background: var(--warning-light); color: var(--warning); }
        .action-item .actions .delete { background: var(--danger-light); color: var(--danger); }
        
        .add-btn { width: 100%; padding: 10px; border: 2px dashed var(--border); border-radius: 8px; background: transparent; color: var(--text-light); font-family: inherit; font-size: 12px; cursor: pointer; }
        .add-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        .tree-container { max-height: 600px; overflow-y: auto; }
        .tree-node { margin-bottom: 4px; }
        .node-row { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg); border-radius: 8px; font-size: 13px; }
        .node-row:hover { background: var(--primary-light); }
        .node-row .icon { font-size: 18px; }
        .node-row .label { flex: 1; font-weight: 600; }
        .node-row .badges { display: flex; gap: 4px; flex-wrap: wrap; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .badge.var { background: var(--cyan-light); color: var(--cyan); }
        .badge.action { background: var(--success-light); color: var(--success); }
        .badge.condition { background: var(--warning-light); color: var(--warning); }
        .node-actions button { width: 24px; height: 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 10px; margin-left: 3px; }
        .node-actions .add { background: var(--success-light); color: var(--success); }
        .node-actions .edit { background: var(--warning-light); color: var(--warning); }
        .node-actions .delete { background: var(--danger-light); color: var(--danger); }
        .node-children { margin-right: 25px; padding-right: 12px; border-right: 2px solid var(--border); }
        
        .settings-group { margin-bottom: 20px; }
        .settings-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; }
        .settings-group input { width: 100%; max-width: 450px; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 13px; }
        .settings-group input:focus { outline: none; border-color: var(--primary); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 15px; }
        .modal.active { display: flex; }
        .modal-box { background: white; border-radius: 16px; padding: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h2 { font-size: 16px; }
        .close-btn { width: 32px; height: 32px; border: none; border-radius: 8px; background: var(--bg); font-size: 16px; cursor: pointer; }
        
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 13px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .type-btns { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
        .type-btn { padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-size: 11px; display: flex; align-items: center; gap: 5px; font-family: inherit; }
        .type-btn:hover { border-color: var(--primary); }
        .type-btn.active { border-color: var(--primary); background: var(--primary-light); }
        .type-btn span { font-size: 16px; }
        
        .switch-row { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 14px; }
        .switch { width: 44px; height: 24px; background: var(--border); border-radius: 12px; position: relative; cursor: pointer; transition: 0.2s; }
        .switch.on { background: var(--success); }
        .switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s; }
        .switch.on::after { left: 22px; }
        
        .upload-area { border: 2px dashed var(--border); border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; }
        .upload-area:hover { border-color: var(--primary); background: var(--primary-light); }
        .upload-area input { display: none; }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 18px; }
        .modal-btns button { flex: 1; padding: 12px; border-radius: 10px; font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: var(--bg); color: var(--text); }
        .btn-save { background: var(--success); color: white; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--success); color: white; padding: 10px 25px; border-radius: 10px; font-weight: 600; opacity: 0; transition: 0.3s; z-index: 2000; font-size: 13px; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); }
        
        .page { display: none; }
        .page.active { display: block; }
        .empty { text-align: center; padding: 40px; color: var(--text-light); }
        .empty span { font-size: 40px; display: block; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠØ©</h1>
        <button class="header-btn" onclick="window.open('index.html','_blank')">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
    </div>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="showPage('tree', this)">ğŸŒ³ Ø§Ù„Ø´Ø¬Ø±Ø©</div>
            <div class="tab" onclick="showPage('actions', this)">ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø£ÙƒØ´Ù†Ø§Øª</div>
            <div class="tab" onclick="showPage('settings', this)">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        </div>
        
        <div class="page active" id="page-tree">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
                    <button class="btn btn-success" onclick="openNodeModal(null)">â• Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ</button>
                </div>
                <div class="tree-container" id="treeContainer"></div>
            </div>
        </div>
        
        <div class="page" id="page-actions">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø£ÙƒØ´Ù†Ø§Øª</h2>
                    <div class="card-actions">
                        <button class="btn btn-primary" onclick="openFolderModal()">â• ÙÙˆÙ„Ø¯Ø±</button>
                        <button class="btn btn-success" onclick="openActionModal()">â• Ø£ÙƒØ´Ù†</button>
                    </div>
                </div>
                <div class="folders-grid" id="foldersGrid"></div>
            </div>
        </div>
        
        <div class="page" id="page-settings">
            <div class="card">
                <div class="card-header"><h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2></div>
                <div class="settings-group">
                    <label>ğŸ”‘ Gemini API Key</label>
                    <input type="password" id="geminiKey" placeholder="AIzaSy...">
                </div>
                <div class="settings-group">
                    <label>ğŸ”— Webhook URL</label>
                    <input type="text" id="webhookUrl" placeholder="https://...">
                </div>
                <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
    
    <!-- Folder Modal -->
    <div class="modal" id="folderModal">
        <div class="modal-box">
            <div class="modal-header"><h2 id="folderModalTitle">ÙÙˆÙ„Ø¯Ø± Ø¬Ø¯ÙŠØ¯</h2><button class="close-btn" onclick="closeModal('folderModal')">Ã—</button></div>
            <form onsubmit="saveFolder(event)">
                <input type="hidden" id="folderId">
                <div class="form-row">
                    <div class="form-group"><label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label><input type="text" id="folderIcon" value="ğŸ“‚" maxlength="2"></div>
                    <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="folderName" required></div>
                </div>
                <div class="modal-btns"><button type="button" class="btn-cancel" onclick="closeModal('folderModal')">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸</button></div>
            </form>
        </div>
    </div>
    
    <!-- Action Modal -->
    <div class="modal" id="actionModal">
        <div class="modal-box">
            <div class="modal-header"><h2 id="actionModalTitle">Ø£ÙƒØ´Ù† Ø¬Ø¯ÙŠØ¯</h2><button class="close-btn" onclick="closeModal('actionModal')">Ã—</button></div>
            <form onsubmit="saveAction(event)">
                <input type="hidden" id="actionId">
                <div class="form-group"><label>ğŸ“‚ Ø§Ù„ÙÙˆÙ„Ø¯Ø±</label><select id="actionFolder"></select></div>
                <label style="font-weight:600;font-size:12px;margin-bottom:8px;display:block;">Ù†ÙˆØ¹ Ø§Ù„Ø£ÙƒØ´Ù†:</label>
                <div class="type-btns">
                    <button type="button" class="type-btn active" data-type="file_ai" onclick="setActionType('file_ai')"><span>ğŸ¤–</span> Ù…Ù„Ù + AI</button>
                    <button type="button" class="type-btn" data-type="static" onclick="setActionType('static')"><span>ğŸ“</span> Ø±Ø¯ Ø«Ø§Ø¨Øª</button>
                    <button type="button" class="type-btn" data-type="phone" onclick="setActionType('phone')"><span>ğŸ“</span> Ø§ØªØµØ§Ù„</button>
                    <button type="button" class="type-btn" data-type="whatsapp" onclick="setActionType('whatsapp')"><span>ğŸ’¬</span> ÙˆØ§ØªØ³Ø§Ø¨</button>
                    <button type="button" class="type-btn" data-type="webhook" onclick="setActionType('webhook')"><span>ğŸ”—</span> Webhook</button>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label><input type="text" id="actionIcon" value="ğŸ“„" maxlength="2"></div>
                    <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="actionName" required></div>
                </div>
                <div id="fileAiFields">
                    <div class="form-group"><label>ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù</label><div class="upload-area" onclick="document.getElementById('actionFile').click()"><span style="font-size:24px;">ğŸ“¤</span><p style="font-size:12px;color:var(--text-light);" id="uploadLabel">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</p><input type="file" id="actionFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.png,.jpg,.jpeg"></div></div>
                    <div class="form-group"><label>ğŸ¤– ØªØ¹Ù„ÙŠÙ…Ø§Øª AI</label><textarea id="actionPrompt" rows="2" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù..."></textarea></div>
                </div>
                <div id="staticFields" style="display:none;"><div class="form-group"><label>Ø§Ù„Ø±Ø¯ Ø¹Ø±Ø¨ÙŠ</label><textarea id="actionRespAr" rows="2"></textarea></div><div class="form-group"><label>Ø§Ù„Ø±Ø¯ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label><textarea id="actionRespEn" rows="2"></textarea></div></div>
                <div id="phoneFields" style="display:none;"><div class="form-group"><label>ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="actionPhone" placeholder="966501234567"></div></div>
                <div id="webhookFields" style="display:none;"><div class="form-group"><label>ğŸ”— Webhook URL</label><input type="text" id="actionWebhook" placeholder="https://..."></div></div>
                <div class="modal-btns"><button type="button" class="btn-cancel" onclick="closeModal('actionModal')">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸</button></div>
            </form>
        </div>
    </div>
    
    <!-- Node Modal -->
    <div class="modal" id="nodeModal">
        <div class="modal-box">
            <div class="modal-header"><h2 id="nodeModalTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</h2><button class="close-btn" onclick="closeModal('nodeModal')">Ã—</button></div>
            <form onsubmit="saveNode(event)">
                <input type="hidden" id="nodeId">
                <div class="form-group"><label>ğŸ“ ÙŠØ¶Ø§Ù ØªØ­Øª</label><select id="nodeParent"></select></div>
                <div class="form-row">
                    <div class="form-group"><label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label><input type="text" id="nodeIcon" value="ğŸ“" maxlength="2"></div>
                    <div class="form-group"><label>Ø§Ù„ØªØ±ØªÙŠØ¨</label><input type="number" id="nodeOrder" value="0" min="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ</label><input type="text" id="nodeLabelAr" required></div>
                    <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label><input type="text" id="nodeLabelEn" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>ğŸ”¤ Ø§Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ±</label><input type="text" id="nodeVar" placeholder="name, emp_id"></div>
                    <div class="form-group"><label>ğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</label><select id="nodeInputType" onchange="toggleNodeOptions()"><option value="none">Ø¨Ø¯ÙˆÙ† (Ù‚Ø³Ù…)</option><option value="text">Ù†Øµ</option><option value="number">Ø±Ù‚Ù…</option><option value="select">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</option><option value="date">ØªØ§Ø±ÙŠØ®</option></select></div>
                </div>
                <div class="form-group" id="nodeOptionsGroup" style="display:none;"><label>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø§Ø®ØªÙŠØ§Ø±)</label><textarea id="nodeOptions" rows="3" placeholder="HR&#10;Finance&#10;IT"></textarea></div>
                <div class="form-group" id="nodeConditionGroup" style="display:none;"><label>ğŸ”— ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© =</label><input type="text" id="nodeCondition" placeholder="HR"></div>
                <div class="switch-row"><div class="switch" id="hasActionSwitch" onclick="toggleHasAction()"></div><label style="flex:1;">âš¡ ÙŠÙ†ÙØ° Ø£ÙƒØ´Ù† Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±</label></div>
                <div id="nodeActionGroup" style="display:none;"><div class="form-group"><label>ğŸ¬ Ø§Ø®ØªØ± Ø§Ù„Ø£ÙƒØ´Ù†</label><select id="nodeAction"></select></div></div>
                <div class="modal-btns"><button type="button" class="btn-cancel" onclick="closeModal('nodeModal')">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="btn-save">ğŸ’¾ Ø­ÙØ¸</button></div>
            </form>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        const SUPABASE_URL = 'https://nrsnsysjmhboovutirdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yc25zeXNqbWhib292dXRpcmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDYxNjYsImV4cCI6MjA4NzE4MjE2Nn0.A6XRe0wUA267hogwWnNpXe08B-MrL1HSjBVbURyLdsU';
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let folders = [], actions = [], tree = [], settings = {};
        let actionType = 'file_ai', hasAction = false;

        async function loadData() {
            const { data: s } = await db.from('settings').select('*').limit(1).single();
            if (s) { settings = s; document.getElementById('geminiKey').value = s.gemini_key || ''; document.getElementById('webhookUrl').value = s.webhook_url || ''; }
            const { data: f } = await db.from('folders').select('*').eq('is_active', true).order('sort_order');
            folders = f || [];
            const { data: a } = await db.from('actions').select('*').eq('is_active', true).order('sort_order');
            actions = a || [];
            const { data: t } = await db.from('tree').select('*').eq('is_active', true).order('sort_order');
            tree = t || [];
            renderFolders(); renderTree(); updateSelects();
        }

        function renderFolders() {
            const grid = document.getElementById('foldersGrid');
            if (!folders.length) { grid.innerHTML = '<div class="empty"><span>ğŸ“­</span><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆÙ„Ø¯Ø±Ø§Øª</p></div>'; return; }
            grid.innerHTML = folders.map(f => {
                const fa = actions.filter(a => a.folder_id === f.id);
                return `<div class="folder-card" id="folder_${f.id}"><div class="folder-header" onclick="toggleFolder('${f.id}')"><span class="icon">${f.icon}</span><span class="name">${f.name}</span><span class="count">${fa.length}</span><div class="folder-actions" onclick="event.stopPropagation()"><button class="edit" onclick="editFolder('${f.id}')">âœï¸</button><button class="delete" onclick="deleteFolder('${f.id}')">ğŸ—‘ï¸</button></div></div><div class="folder-content">${fa.map(a => `<div class="action-item"><span class="icon">${a.icon}</span><div class="info"><div class="name">${a.name}</div><div class="type">${getActionTypeLabel(a.action_type)}</div></div><div class="actions"><button class="edit" onclick="editAction('${a.id}')">âœï¸</button><button class="delete" onclick="deleteAction('${a.id}')">ğŸ—‘ï¸</button></div></div>`).join('') || '<p style="text-align:center;color:var(--text-light);padding:10px;font-size:12px;">ÙØ§Ø±Øº</p>'}<button class="add-btn" onclick="openActionModal('${f.id}')">â• Ø£ÙƒØ´Ù† Ø¬Ø¯ÙŠØ¯</button></div></div>`;
            }).join('');
        }

        function getActionTypeLabel(type) { return { file_ai: 'ğŸ¤– Ù…Ù„Ù + AI', static: 'ğŸ“ Ø±Ø¯ Ø«Ø§Ø¨Øª', phone: 'ğŸ“ Ø§ØªØµØ§Ù„', whatsapp: 'ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨', webhook: 'ğŸ”— Webhook' }[type] || type; }
        window.toggleFolder = (id) => document.getElementById('folder_' + id)?.classList.toggle('open');

        window.openFolderModal = (id) => {
            document.getElementById('folderModalTitle').textContent = id ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆÙ„Ø¯Ø±' : 'ÙÙˆÙ„Ø¯Ø± Ø¬Ø¯ÙŠØ¯';
            document.getElementById('folderId').value = id || '';
            const f = id ? folders.find(x => x.id === id) : null;
            document.getElementById('folderIcon').value = f?.icon || 'ğŸ“‚';
            document.getElementById('folderName').value = f?.name || '';
            openModal('folderModal');
        };
        window.editFolder = (id) => openFolderModal(id);
        window.saveFolder = async (e) => { e.preventDefault(); const id = document.getElementById('folderId').value; const data = { icon: document.getElementById('folderIcon').value, name: document.getElementById('folderName').value }; if (id) await db.from('folders').update(data).eq('id', id); else await db.from('folders').insert({ ...data, sort_order: folders.length }); toast('ØªÙ… âœ…'); closeModal('folderModal'); loadData(); };
        window.deleteFolder = async (id) => { if (!confirm('Ø­Ø°Ù Ø§Ù„ÙÙˆÙ„Ø¯Ø±ØŸ')) return; await db.from('folders').update({ is_active: false }).eq('id', id); toast('ØªÙ…'); loadData(); };

        window.openActionModal = (folderId) => {
            document.getElementById('actionModalTitle').textContent = 'Ø£ÙƒØ´Ù† Ø¬Ø¯ÙŠØ¯';
            document.getElementById('actionId').value = '';
            document.getElementById('actionIcon').value = 'ğŸ“„';
            document.getElementById('actionName').value = '';
            document.getElementById('actionPrompt').value = '';
            document.getElementById('actionRespAr').value = '';
            document.getElementById('actionRespEn').value = '';
            document.getElementById('actionPhone').value = '';
            document.getElementById('actionWebhook').value = '';
            document.getElementById('uploadLabel').textContent = 'Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù';
            document.getElementById('actionFile').dataset.fileName = '';
            setActionType('file_ai');
            updateFolderSelect(folderId);
            openModal('actionModal');
        };
        window.editAction = (id) => {
            const a = actions.find(x => x.id === id);
            document.getElementById('actionModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙƒØ´Ù†';
            document.getElementById('actionId').value = id;
            document.getElementById('actionIcon').value = a.icon;
            document.getElementById('actionName').value = a.name;
            document.getElementById('actionPrompt').value = a.ai_prompt || '';
            document.getElementById('actionRespAr').value = a.response_ar || '';
            document.getElementById('actionRespEn').value = a.response_en || '';
            document.getElementById('actionPhone').value = a.phone_number || '';
            document.getElementById('actionWebhook').value = a.webhook_url || '';
            document.getElementById('uploadLabel').textContent = a.file_name ? 'âœ… ' + a.file_name.split('_').slice(1).join('_') : 'Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù';
            document.getElementById('actionFile').dataset.fileName = a.file_name || '';
            setActionType(a.action_type);
            updateFolderSelect(a.folder_id);
            openModal('actionModal');
        };
        window.setActionType = (type) => { actionType = type; document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === type)); document.getElementById('fileAiFields').style.display = type === 'file_ai' ? '' : 'none'; document.getElementById('staticFields').style.display = type === 'static' ? '' : 'none'; document.getElementById('phoneFields').style.display = (type === 'phone' || type === 'whatsapp') ? '' : 'none'; document.getElementById('webhookFields').style.display = type === 'webhook' ? '' : 'none'; };
        document.getElementById('actionFile').addEventListener('change', async (e) => { const file = e.target.files[0]; if (!file) return; document.getElementById('uploadLabel').textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...'; const fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g, '_'); const { error } = await db.storage.from('files').upload(fileName, file, { upsert: true }); if (error) { toast('Ø®Ø·Ø£', true); return; } document.getElementById('uploadLabel').textContent = 'âœ… ' + file.name; document.getElementById('actionFile').dataset.fileName = fileName; toast('ØªÙ… âœ…'); });
        window.saveAction = async (e) => { e.preventDefault(); const id = document.getElementById('actionId').value; const data = { folder_id: document.getElementById('actionFolder').value || null, icon: document.getElementById('actionIcon').value, name: document.getElementById('actionName').value, action_type: actionType, file_name: document.getElementById('actionFile').dataset.fileName || null, ai_prompt: document.getElementById('actionPrompt').value || null, response_ar: document.getElementById('actionRespAr').value || null, response_en: document.getElementById('actionRespEn').value || null, phone_number: document.getElementById('actionPhone').value || null, webhook_url: document.getElementById('actionWebhook').value || null }; if (id) await db.from('actions').update(data).eq('id', id); else await db.from('actions').insert({ ...data, sort_order: actions.length }); toast('ØªÙ… âœ…'); closeModal('actionModal'); loadData(); };
        window.deleteAction = async (id) => { if (!confirm('Ø­Ø°ÙØŸ')) return; await db.from('actions').update({ is_active: false }).eq('id', id); toast('ØªÙ…'); loadData(); };
        function updateFolderSelect(selected) { document.getElementById('actionFolder').innerHTML = '<option value="">-- Ø¨Ø¯ÙˆÙ† --</option>' + folders.map(f => `<option value="${f.id}" ${f.id === selected ? 'selected' : ''}>${f.icon} ${f.name}</option>`).join(''); }

        function renderTree() {
            const container = document.getElementById('treeContainer');
            const roots = tree.filter(n => !n.parent_id);
            if (!roots.length) { container.innerHTML = '<div class="empty"><span>ğŸŒ³</span><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</p></div>'; return; }
            container.innerHTML = roots.map(n => renderNode(n)).join('');
        }
        function renderNode(node) {
            const children = tree.filter(n => n.parent_id === node.id);
            const action = node.action_id ? actions.find(a => a.id === node.action_id) : null;
            let badges = '';
            if (node.var_name) badges += `<span class="badge var">{${node.var_name}}</span>`;
            if (node.show_if_value) badges += `<span class="badge condition">Ø¥Ø°Ø§: ${node.show_if_value}</span>`;
            if (action) badges += `<span class="badge action">${action.icon} ${action.name}</span>`;
            return `<div class="tree-node"><div class="node-row"><span class="icon">${node.icon}</span><span class="label">${node.label_ar}</span><div class="badges">${badges}</div><div class="node-actions"><button class="add" onclick="openNodeModal('${node.id}')">â•</button><button class="edit" onclick="editNode('${node.id}')">âœï¸</button><button class="delete" onclick="deleteNode('${node.id}')">ğŸ—‘ï¸</button></div></div>${children.length ? `<div class="node-children">${children.map(c => renderNode(c)).join('')}</div>` : ''}</div>`;
        }

        window.openNodeModal = (parentId) => {
            document.getElementById('nodeModalTitle').textContent = parentId ? 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ÙØ±Ø¹ÙŠ' : 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø±Ø¦ÙŠØ³ÙŠ';
            document.getElementById('nodeId').value = '';
            document.getElementById('nodeIcon').value = parentId ? 'â“' : 'ğŸ“';
            document.getElementById('nodeOrder').value = '0';
            document.getElementById('nodeLabelAr').value = '';
            document.getElementById('nodeLabelEn').value = '';
            document.getElementById('nodeVar').value = '';
            document.getElementById('nodeInputType').value = parentId ? 'text' : 'none';
            document.getElementById('nodeOptions').value = '';
            document.getElementById('nodeCondition').value = '';
            document.getElementById('nodeAction').value = '';
            hasAction = false;
            document.getElementById('hasActionSwitch').classList.remove('on');
            document.getElementById('nodeActionGroup').style.display = 'none';
            updateParentSelect(parentId);
            updateActionSelect();
            toggleNodeOptions();
            checkShowCondition(parentId);
            openModal('nodeModal');
        };
        window.editNode = (id) => {
            const n = tree.find(x => x.id === id);
            document.getElementById('nodeModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±';
            document.getElementById('nodeId').value = id;
            document.getElementById('nodeIcon').value = n.icon;
            document.getElementById('nodeOrder').value = n.sort_order || 0;
            document.getElementById('nodeLabelAr').value = n.label_ar;
            document.getElementById('nodeLabelEn').value = n.label_en;
            document.getElementById('nodeVar').value = n.var_name || '';
            document.getElementById('nodeInputType').value = n.input_type || 'none';
            document.getElementById('nodeOptions').value = n.options || '';
            document.getElementById('nodeCondition').value = n.show_if_value || '';
            document.getElementById('nodeAction').value = n.action_id || '';
            hasAction = n.has_action || false;
            document.getElementById('hasActionSwitch').classList.toggle('on', hasAction);
            document.getElementById('nodeActionGroup').style.display = hasAction ? '' : 'none';
            updateParentSelect(n.parent_id, id);
            updateActionSelect();
            toggleNodeOptions();
            checkShowCondition(n.parent_id);
            openModal('nodeModal');
        };
        window.saveNode = async (e) => { e.preventDefault(); const id = document.getElementById('nodeId').value; const data = { parent_id: document.getElementById('nodeParent').value || null, icon: document.getElementById('nodeIcon').value, sort_order: parseInt(document.getElementById('nodeOrder').value) || 0, label_ar: document.getElementById('nodeLabelAr').value, label_en: document.getElementById('nodeLabelEn').value, var_name: document.getElementById('nodeVar').value || null, input_type: document.getElementById('nodeInputType').value, options: document.getElementById('nodeOptions').value || null, show_if_value: document.getElementById('nodeCondition').value || null, has_action: hasAction, action_id: hasAction ? (document.getElementById('nodeAction').value || null) : null }; if (id) await db.from('tree').update(data).eq('id', id); else await db.from('tree').insert(data); toast('ØªÙ… âœ…'); closeModal('nodeModal'); loadData(); };
        window.deleteNode = async (id) => { if (!confirm('Ø­Ø°ÙØŸ')) return; await db.from('tree').update({ is_active: false }).eq('id', id); toast('ØªÙ…'); loadData(); };
        window.toggleHasAction = () => { hasAction = !hasAction; document.getElementById('hasActionSwitch').classList.toggle('on', hasAction); document.getElementById('nodeActionGroup').style.display = hasAction ? '' : 'none'; };
        window.toggleNodeOptions = () => { document.getElementById('nodeOptionsGroup').style.display = document.getElementById('nodeInputType').value === 'select' ? '' : 'none'; };
        function checkShowCondition(parentId) { const parent = tree.find(n => n.id === parentId); document.getElementById('nodeConditionGroup').style.display = (parent?.input_type === 'select') ? '' : 'none'; }
        function updateParentSelect(selectedId, excludeId) { let opts = '<option value="">ğŸ  Ø§Ù„Ø¬Ø°Ø±</option>'; const add = (nodes, lvl = 0) => { nodes.forEach(n => { if (n.id !== excludeId) { opts += `<option value="${n.id}" ${n.id === selectedId ? 'selected' : ''}>${'â€”'.repeat(lvl)} ${n.icon} ${n.label_ar}</option>`; add(tree.filter(c => c.parent_id === n.id), lvl + 1); } }); }; add(tree.filter(n => !n.parent_id)); document.getElementById('nodeParent').innerHTML = opts; }
        function updateActionSelect() { let opts = '<option value="">-- Ø§Ø®ØªØ± --</option>'; folders.forEach(f => { const fa = actions.filter(a => a.folder_id === f.id); if (fa.length) { opts += `<optgroup label="${f.icon} ${f.name}">${fa.map(a => `<option value="${a.id}">${a.icon} ${a.name}</option>`).join('')}</optgroup>`; } }); const na = actions.filter(a => !a.folder_id); if (na.length) { opts += `<optgroup label="Ø¨Ø¯ÙˆÙ† ÙÙˆÙ„Ø¯Ø±">${na.map(a => `<option value="${a.id}">${a.icon} ${a.name}</option>`).join('')}</optgroup>`; } document.getElementById('nodeAction').innerHTML = opts; }
        function updateSelects() { updateFolderSelect(); updateActionSelect(); }

        window.saveSettings = async () => { const data = { gemini_key: document.getElementById('geminiKey').value, webhook_url: document.getElementById('webhookUrl').value }; if (settings.id) await db.from('settings').update(data).eq('id', settings.id); else await db.from('settings').insert(data); settings = { ...settings, ...data }; toast('ØªÙ… âœ…'); };

        window.showPage = (page, el) => { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.getElementById('page-' + page).classList.add('active'); el.classList.add('active'); };
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        function toast(msg, isError = false) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (isError ? ' error' : ''); setTimeout(() => t.classList.remove('show'), 2500); }
        document.querySelectorAll('.modal').forEach(m => { m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }); });
        loadData();
    </script>
</body>
</html>
