<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5; --primary-light: #EEF2FF;
            --success: #10B981; --bg: #F8FAFC;
            --card: #FFFFFF; --text: #1E293B;
            --text-light: #64748B; --border: #E2E8F0;
            --gradient: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 16px; }
        body.en { direction: ltr; font-family: 'Inter', sans-serif; }
        
        .container { width: 100%; max-width: 480px; height: 94vh; max-height: 850px; background: var(--card); border-radius: 24px; box-shadow: 0 20px 60px rgba(79,70,229,0.15); display: flex; flex-direction: column; overflow: hidden; }
        
        .header { background: var(--gradient); padding: 20px; color: white; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .lang-switch { display: flex; background: rgba(255,255,255,0.15); border-radius: 10px; overflow: hidden; }
        .lang-btn { padding: 8px 14px; background: transparent; border: none; color: rgba(255,255,255,0.7); font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .lang-btn.active { background: rgba(255,255,255,0.25); color: white; }
        .header-main { display: flex; align-items: center; gap: 14px; }
        .avatar { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .header-info h1 { font-size: 18px; font-weight: 700; }
        .header-info p { font-size: 13px; opacity: 0.9; }
        
        .chat { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 14px; }
        
        .msg { display: flex; gap: 10px; animation: fadeIn 0.3s; }
        .msg.user { flex-direction: row-reverse; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .msg-avatar { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
        .msg.bot .msg-avatar { background: var(--primary-light); }
        .msg.user .msg-avatar { background: var(--gradient); color: white; }
        .msg-content { max-width: 85%; }
        .msg-bubble { padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.6; }
        .msg.bot .msg-bubble { background: var(--bg); color: var(--text); border-bottom-right-radius: 5px; }
        body.en .msg.bot .msg-bubble { border-bottom-right-radius: 18px; border-bottom-left-radius: 5px; }
        .msg.user .msg-bubble { background: var(--gradient); color: white; border-bottom-left-radius: 5px; }
        .msg-time { font-size: 10px; color: var(--text-light); margin-top: 4px; }
        
        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 12px; }
        .menu-btn { padding: 16px 12px; background: white; border: 2px solid var(--border); border-radius: 14px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px; font-family: inherit; }
        .menu-btn:hover { border-color: var(--primary); background: var(--primary-light); }
        .menu-btn .icon { font-size: 28px; }
        .menu-btn .label { font-size: 13px; font-weight: 600; color: var(--text); }
        
        .quick-btns { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .quick-btn { padding: 10px 16px; background: white; border: 2px solid var(--primary); border-radius: 22px; color: var(--primary); font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .quick-btn:hover { background: var(--primary); color: white; }
        .quick-btn.green { border-color: var(--success); color: var(--success); }
        .quick-btn.green:hover { background: var(--success); color: white; }
        
        .info-card { background: linear-gradient(135deg, var(--primary-light), #F3E8FF); border-radius: 14px; padding: 14px; margin-top: 12px; white-space: pre-line; font-size: 14px; line-height: 1.7; }
        
        .ai-badge { display: inline-flex; align-items: center; gap: 4px; background: #DBEAFE; color: #1D4ED8; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-bottom: 8px; }
        
        .back-btn { display: inline-flex; align-items: center; gap: 5px; padding: 8px 16px; background: white; border: 1px solid var(--border); border-radius: 20px; color: var(--text-light); font-family: inherit; font-size: 12px; cursor: pointer; margin-top: 12px; }
        .back-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        .typing { display: flex; gap: 4px; padding: 14px 18px; background: var(--bg); border-radius: 18px; width: fit-content; }
        .typing span { width: 7px; height: 7px; background: var(--text-light); border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
        
        .input-area { padding: 14px 16px; background: white; border-top: 1px solid var(--border); }
        .input-wrap { display: flex; gap: 10px; }
        .input-field { flex: 1; padding: 12px 18px; border: 2px solid var(--border); border-radius: 25px; font-family: inherit; font-size: 14px; outline: none; }
        .input-field:focus { border-color: var(--primary); }
        .send-btn { width: 48px; height: 48px; background: var(--gradient); border: none; border-radius: 50%; color: white; font-size: 18px; cursor: pointer; }
        
        .loading { text-align: center; padding: 40px; color: var(--text-light); }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 500px) { body { padding: 0; } .container { height: 100vh; max-height: none; border-radius: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div></div>
                <div class="lang-switch">
                    <button class="lang-btn active" id="btnAr" onclick="switchLang('ar')">Ø¹Ø±Ø¨ÙŠ</button>
                    <button class="lang-btn" id="btnEn" onclick="switchLang('en')">EN</button>
                </div>
            </div>
            <div class="header-main">
                <div class="avatar">ğŸ¤–</div>
                <div class="header-info">
                    <h1 id="title">Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
                    <p id="subtitle">Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                </div>
            </div>
        </div>
        <div class="chat" id="chat">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>
        <div class="input-area">
            <div class="input-wrap">
                <input type="text" class="input-field" id="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ..." autocomplete="off">
                <button class="send-btn" onclick="sendMsg()">â¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://nrsnsysjmhboovutirdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yc25zeXNqbWhib292dXRpcmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDYxNjYsImV4cCI6MjA4NzE4MjE2Nn0.A6XRe0wUA267hogwWnNpXe08B-MrL1HSjBVbURyLdsU';
        const GEMINI_API = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let categories = [], items = [], settings = {};
        let lang = localStorage.getItem('appLang') || 'ar';
        let history = [];
        let currentItem = null;
        
        const L = {
            ar: { title: 'Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', subtitle: 'Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ', welcome: 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹<br>ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ', placeholder: 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ...', back: 'â†’ Ø±Ø¬ÙˆØ¹', home: 'ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', thinking: 'ğŸ¤– Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...', askQuestion: 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:', aiAnswer: 'ğŸ¤– Ø¥Ø¬Ø§Ø¨Ø© AI' },
            en: { title: 'Employee Support', subtitle: 'AI Powered', welcome: 'Welcome! ğŸ‘‹<br>How can I help?', placeholder: 'Type question...', back: 'â† Back', home: 'ğŸ  Home', thinking: 'ğŸ¤– Thinking...', askQuestion: 'Ask your question about this topic:', aiAnswer: 'ğŸ¤– AI Answer' }
        };

        async function loadData() {
            try {
                const { data: s } = await db.from('settings').select('*').limit(1).single();
                if (s) settings = s;
                
                const { data: c } = await db.from('categories').select('*').eq('is_active', true).order('sort_order');
                categories = c || [];
                
                const { data: i } = await db.from('items').select('*').eq('is_active', true).order('sort_order');
                items = i || [];
                
                document.getElementById('subtitle').textContent = L[lang].subtitle;
                showMain();
            } catch (e) {
                console.error(e);
                document.getElementById('chat').innerHTML = '<div class="loading">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>';
            }
        }

        window.switchLang = (l) => {
            lang = l;
            localStorage.setItem('appLang', l);
            document.body.className = l === 'en' ? 'en' : '';
            document.documentElement.lang = l;
            document.documentElement.dir = l === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('btnAr').className = 'lang-btn' + (l === 'ar' ? ' active' : '');
            document.getElementById('btnEn').className = 'lang-btn' + (l === 'en' ? ' active' : '');
            document.getElementById('title').textContent = L[l].title;
            document.getElementById('subtitle').textContent = L[l].subtitle;
            document.getElementById('input').placeholder = L[l].placeholder;
            showMain();
        };

        function T(k) { return L[lang][k]; }
        function getName(obj, field) { return obj[field + '_' + lang] || obj[field + '_ar'] || ''; }
        function time() { return new Date().toLocaleTimeString(lang === 'ar' ? 'ar-EG' : 'en-US', { hour: '2-digit', minute: '2-digit' }); }
        function scroll() { document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight; }

        function typing() {
            const d = document.createElement('div');
            d.className = 'msg bot'; d.id = 'typing';
            d.innerHTML = `<div class="msg-avatar">ğŸ¤–</div><div class="msg-content"><div class="typing"><span></span><span></span><span></span></div></div>`;
            document.getElementById('chat').appendChild(d);
            scroll();
        }

        function untype() { document.getElementById('typing')?.remove(); }

        function bot(txt, extra = '') {
            untype();
            const d = document.createElement('div');
            d.className = 'msg bot';
            d.innerHTML = `<div class="msg-avatar">ğŸ¤–</div><div class="msg-content">${txt ? `<div class="msg-bubble">${txt}</div>` : ''}${extra}<div class="msg-time">${time()}</div></div>`;
            document.getElementById('chat').appendChild(d);
            scroll();
        }

        function user(txt) {
            const d = document.createElement('div');
            d.className = 'msg user';
            d.innerHTML = `<div class="msg-avatar">ğŸ‘¤</div><div class="msg-content"><div class="msg-bubble">${txt}</div><div class="msg-time">${time()}</div></div>`;
            document.getElementById('chat').appendChild(d);
            scroll();
        }

        function showMain() {
            document.getElementById('chat').innerHTML = '';
            history = [];
            currentItem = null;
            
            if (!categories.length) {
                bot('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }

            typing();
            setTimeout(() => {
                let btns = categories.map(c => 
                    `<button class="menu-btn" onclick="openCat('${c.id}')">
                        <span class="icon">${c.icon}</span>
                        <span class="label">${getName(c, 'name')}</span>
                    </button>`
                ).join('');
                bot(T('welcome'), `<div class="btn-grid">${btns}</div>`);
            }, 400);
        }

        window.openCat = (catId) => {
            const cat = categories.find(c => c.id === catId);
            if (!cat) return;
            
            history.push({ type: 'main' });
            user(getName(cat, 'name'));
            
            const catItems = items.filter(i => i.category_id === catId);
            
            typing();
            setTimeout(() => {
                if (!catItems.length) {
                    bot('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©', `<button class="back-btn" onclick="goBack()">${T('back')}</button>`);
                    return;
                }
                let btns = catItems.map(i => 
                    `<button class="quick-btn" onclick="openItem('${i.id}')">${i.icon} ${getName(i, 'label')}</button>`
                ).join('');
                bot(`${cat.icon} ${getName(cat, 'name')}`, `<div class="quick-btns">${btns}</div><button class="back-btn" onclick="goBack()">${T('back')}</button>`);
            }, 400);
        };

        window.openItem = (itemId) => {
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            
            history.push({ type: 'cat', catId: item.category_id });
            user(getName(item, 'label'));
            currentItem = item;

            const answerType = item.answer_type || 'static';

            if (answerType === 'static') {
                // Static answer
                typing();
                setTimeout(() => {
                    const resp = getName(item, 'response') || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø©';
                    bot('', `<div class="info-card">${resp}</div><div class="quick-btns" style="margin-top:10px;"><button class="quick-btn green" onclick="goHome()">${T('home')}</button></div><button class="back-btn" onclick="goBack()">${T('back')}</button>`);
                }, 500);
            } else if (answerType === 'ai') {
                // AI answer - ask for question
                typing();
                setTimeout(() => {
                    bot(T('askQuestion'), `<button class="back-btn" onclick="goBack()">${T('back')}</button>`);
                    document.getElementById('input').focus();
                }, 400);
            } else if (answerType === 'webhook') {
                // Webhook
                sendWebhook(item);
                typing();
                setTimeout(() => {
                    bot('', `<div class="info-card">ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹</div><div class="quick-btns" style="margin-top:10px;"><button class="quick-btn green" onclick="goHome()">${T('home')}</button></div>`);
                }, 500);
            }
        };

        async function askGemini(question, fileName, prompt) {
            if (!settings.gemini_key) {
                return 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ AI Ø¨Ø¹Ø¯';
            }

            try {
                // Get file content if exists
                let fileContent = '';
                if (fileName) {
                    const { data } = await db.storage.from('files').download(fileName);
                    if (data) {
                        fileContent = await data.text();
                    }
                }

                const systemPrompt = prompt || 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ØªØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†. Ø£Ø¬Ø¨ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ± ÙˆÙ…ÙÙŠØ¯.';
                const fullPrompt = fileContent 
                    ? `${systemPrompt}\n\nØ§Ù„Ù…Ø³ØªÙ†Ø¯:\n${fileContent}\n\nØ§Ù„Ø³Ø¤Ø§Ù„: ${question}`
                    : `${systemPrompt}\n\nØ§Ù„Ø³Ø¤Ø§Ù„: ${question}`;

                const response = await fetch(`${GEMINI_API}?key=${settings.gemini_key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }]
                    })
                });

                const data = await response.json();
                
                if (data.candidates && data.candidates[0]) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    return 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
                }
            } catch (e) {
                console.error('Gemini Error:', e);
                return 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ AI';
            }
        }

        function sendWebhook(item) {
            if (!settings.webhook_url) return;
            fetch(settings.webhook_url, {
                method: 'POST',
                body: JSON.stringify({
                    type: 'item_click',
                    item_id: item.id,
                    label: getName(item, 'label'),
                    timestamp: new Date().toISOString()
                }),
                mode: 'no-cors'
            }).catch(() => {});
        }

        window.sendMsg = async () => {
            const inp = document.getElementById('input');
            const txt = inp.value.trim();
            if (!txt) return;
            
            user(txt);
            inp.value = '';

            if (currentItem && currentItem.answer_type === 'ai') {
                // AI mode
                typing();
                const answer = await askGemini(txt, currentItem.file_name, currentItem.ai_prompt);
                bot('', `
                    <div class="ai-badge">ğŸ¤– ${T('aiAnswer')}</div>
                    <div class="info-card">${answer}</div>
                    <div class="quick-btns" style="margin-top:10px;">
                        <button class="quick-btn green" onclick="goHome()">${T('home')}</button>
                    </div>
                    <button class="back-btn" onclick="goBack()">${T('back')}</button>
                `);
            } else {
                // Free question - send to AI without file
                typing();
                const answer = await askGemini(txt, null, 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ© Ø°ÙƒÙŠ. Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø´ÙƒÙ„ Ù…ÙÙŠØ¯ ÙˆÙ…Ø®ØªØµØ±.');
                bot('', `
                    <div class="ai-badge">ğŸ¤– ${T('aiAnswer')}</div>
                    <div class="info-card">${answer}</div>
                    <div class="quick-btns" style="margin-top:10px;">
                        <button class="quick-btn green" onclick="goHome()">${T('home')}</button>
                    </div>
                `);
            }
        };

        window.goBack = () => {
            if (!history.length) return;
            user(T('back'));
            const h = history.pop();
            currentItem = null;
            if (h.type === 'main') showMain();
            else if (h.type === 'cat') {
                const cat = categories.find(c => c.id === h.catId);
                const catItems = items.filter(i => i.category_id === h.catId);
                typing();
                setTimeout(() => {
                    let btns = catItems.map(i => 
                        `<button class="quick-btn" onclick="openItem('${i.id}')">${i.icon} ${getName(i, 'label')}</button>`
                    ).join('');
                    bot(`${cat?.icon || ''} ${getName(cat, 'name')}`, `<div class="quick-btns">${btns}</div><button class="back-btn" onclick="goBack()">${T('back')}</button>`);
                }, 300);
            }
            else showMain();
        };

        window.goHome = () => {
            user(T('home'));
            showMain();
        };

        document.getElementById('input').addEventListener('keypress', e => { if (e.key === 'Enter') window.sendMsg(); });
        
        document.getElementById('btnAr').className = 'lang-btn' + (lang === 'ar' ? ' active' : '');
        document.getElementById('btnEn').className = 'lang-btn' + (lang === 'en' ? ' active' : '');
        document.body.className = lang === 'en' ? 'en' : '';
        document.getElementById('title').textContent = L[lang].title;
        document.getElementById('input').placeholder = L[lang].placeholder;
        
        loadData();
    </script>
</body>
</html>
