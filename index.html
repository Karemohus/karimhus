<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6366F1; --primary-light: #E0E7FF;
            --success: #10B981; --success-light: #D1FAE5;
            --warning: #F59E0B; --warning-light: #FEF3C7;
            --bg: #F8FAFC; --card: #FFFFFF;
            --text: #1E293B; --text-light: #64748B;
            --border: #E2E8F0;
            --gradient: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 16px; }
        body.en { direction: ltr; font-family: 'Inter', sans-serif; }
        
        .container { width: 100%; max-width: 440px; height: 92vh; max-height: 800px; background: var(--card); border-radius: 28px; box-shadow: 0 25px 80px rgba(99,102,241,0.15); display: flex; flex-direction: column; overflow: hidden; }
        
        .header { background: var(--gradient); padding: 20px; color: white; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .lang-switch { display: flex; background: rgba(255,255,255,0.15); border-radius: 8px; overflow: hidden; }
        .lang-btn { padding: 6px 14px; background: transparent; border: none; color: rgba(255,255,255,0.7); font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; transition: 0.2s; }
        .lang-btn.active { background: rgba(255,255,255,0.25); color: white; }
        .header-main { display: flex; align-items: center; gap: 14px; }
        .avatar { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .header-info h1 { font-size: 18px; font-weight: 700; }
        .header-info p { font-size: 12px; opacity: 0.9; }
        
        .chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        
        .msg { display: flex; gap: 12px; animation: fadeIn 0.3s ease; }
        .msg.user { flex-direction: row-reverse; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-avatar { width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
        .msg.bot .msg-avatar { background: var(--primary-light); }
        .msg.user .msg-avatar { background: var(--gradient); color: white; }
        
        .msg-content { max-width: 85%; }
        .msg-bubble { padding: 14px 18px; border-radius: 20px; font-size: 14px; line-height: 1.7; }
        .msg.bot .msg-bubble { background: var(--bg); color: var(--text); border-bottom-right-radius: 6px; }
        body.en .msg.bot .msg-bubble { border-bottom-right-radius: 20px; border-bottom-left-radius: 6px; }
        .msg.user .msg-bubble { background: var(--gradient); color: white; border-bottom-left-radius: 6px; }
        .msg-time { font-size: 10px; color: var(--text-light); margin-top: 6px; padding: 0 4px; }
        
        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 14px; }
        .menu-btn { padding: 20px 14px; background: white; border: 2px solid var(--border); border-radius: 16px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 10px; font-family: inherit; }
        .menu-btn:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-2px); }
        .menu-btn .icon { font-size: 32px; }
        .menu-btn .label { font-size: 14px; font-weight: 600; color: var(--text); }
        
        .quick-btns { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; }
        .quick-btn { padding: 12px 20px; background: white; border: 2px solid var(--primary); border-radius: 25px; color: var(--primary); font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .quick-btn:hover { background: var(--primary); color: white; }
        .quick-btn.green { border-color: var(--success); color: var(--success); }
        .quick-btn.green:hover { background: var(--success); color: white; }
        
        .info-card { background: linear-gradient(135deg, var(--primary-light), #F3E8FF); border-radius: 16px; padding: 18px; margin-top: 14px; font-size: 14px; line-height: 1.8; white-space: pre-wrap; }
        
        .contact-card { background: var(--success-light); border-radius: 16px; padding: 24px; margin-top: 14px; text-align: center; }
        .contact-card a { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 16px 32px; background: var(--success); color: white; text-decoration: none; border-radius: 30px; font-weight: 700; font-size: 16px; }
        .contact-card.whatsapp a { background: #25D366; }
        
        .ai-badge { display: inline-flex; align-items: center; gap: 6px; background: #DBEAFE; color: #1D4ED8; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-bottom: 10px; }
        
        .data-summary { background: white; border-radius: 12px; padding: 14px; margin: 12px 0; border: 1px solid var(--border); }
        .data-summary-title { font-size: 12px; font-weight: 700; color: var(--text-light); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .data-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .data-row:last-child { border: none; }
        .data-row .key { color: var(--text-light); }
        .data-row .value { font-weight: 600; color: var(--text); }
        
        .back-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; background: white; border: 1px solid var(--border); border-radius: 25px; color: var(--text-light); font-family: inherit; font-size: 13px; cursor: pointer; margin-top: 14px; transition: 0.2s; }
        .back-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        
        .typing { display: flex; gap: 6px; padding: 16px 20px; background: var(--bg); border-radius: 20px; width: fit-content; }
        .typing span { width: 8px; height: 8px; background: var(--text-light); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }
        
        .input-area { padding: 16px 20px; background: white; border-top: 1px solid var(--border); }
        .input-wrap { display: flex; gap: 12px; }
        .input-field { flex: 1; padding: 14px 20px; border: 2px solid var(--border); border-radius: 25px; font-family: inherit; font-size: 14px; outline: none; transition: 0.2s; }
        .input-field:focus { border-color: var(--primary); }
        .send-btn { width: 52px; height: 52px; background: var(--gradient); border: none; border-radius: 50%; color: white; font-size: 20px; cursor: pointer; transition: 0.2s; }
        .send-btn:hover { transform: scale(1.05); }
        
        .loading { text-align: center; padding: 40px; color: var(--text-light); }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 14px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error-card { background: #FEF2F2; border: 1px solid #FCA5A5; border-radius: 12px; padding: 14px; margin-top: 12px; color: #B91C1C; font-size: 13px; }
        
        .debug-info { background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 10px; margin-top: 10px; font-size: 11px; color: #92400E; }
        
        @media (max-width: 480px) {
            body { padding: 0; }
            .container { height: 100vh; max-height: none; border-radius: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div></div>
                <div class="lang-switch">
                    <button class="lang-btn active" id="btnAr" onclick="switchLang('ar')">Ø¹Ø±Ø¨ÙŠ</button>
                    <button class="lang-btn" id="btnEn" onclick="switchLang('en')">EN</button>
                </div>
            </div>
            <div class="header-main">
                <div class="avatar">ğŸ¤–</div>
                <div class="header-info">
                    <h1 id="headerTitle">Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
                    <p id="headerSubtitle">Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                </div>
            </div>
        </div>
        
        <div class="chat" id="chat">
            <div class="loading">
                <div class="spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-wrap">
                <input type="text" class="input-field" id="userInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off">
                <button class="send-btn" onclick="handleUserInput()">â¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://nrsnsysjmhboovutirdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yc25zeXNqbWhib292dXRpcmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDYxNjYsImV4cCI6MjA4NzE4MjE2Nn0.A6XRe0wUA267hogwWnNpXe08B-MrL1HSjBVbURyLdsU';
        const GEMINI_API = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // State
        let flowNodes = [], files = [], settings = {};
        let lang = localStorage.getItem('chat_lang') || 'ar';
        let currentNode = null;
        let collectedData = {};
        let awaitingInput = false;
        let history = [];
        let visitedNodes = []; // Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø±
        
        // Translations
        const T = {
            ar: {
                title: 'Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
                subtitle: 'Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
                welcome: 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹\nÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ',
                placeholder: 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...',
                back: 'â† Ø±Ø¬ÙˆØ¹',
                home: 'ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
                searching: 'ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...',
                aiAnswer: 'ğŸ¤– Ø¥Ø¬Ø§Ø¨Ø© Ø°ÙƒÙŠØ©',
                yourData: 'ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ¯Ø®Ù„Ø©',
                call: 'ğŸ“ Ø§ØªØµÙ„ Ø§Ù„Ø¢Ù†',
                whatsapp: 'ğŸ’¬ ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨',
                noData: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
                error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰',
                notFound: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©',
                noAction: 'Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø±'
            },
            en: {
                title: 'Employee Support Center',
                subtitle: 'AI Powered',
                welcome: 'Welcome! ğŸ‘‹\nHow can I help you today?',
                placeholder: 'Type your message...',
                back: 'â† Back',
                home: 'ğŸ  Home',
                searching: 'ğŸ” Searching data...',
                aiAnswer: 'ğŸ¤– AI Answer',
                yourData: 'ğŸ“‹ Your Data',
                call: 'ğŸ“ Call Now',
                whatsapp: 'ğŸ’¬ WhatsApp',
                noData: 'No data available',
                error: 'Error occurred, please try again',
                notFound: 'No matching results found',
                noAction: 'No action configured for this path'
            }
        };
        
        function t(key) { return T[lang][key] || key; }
        function getLabel(obj, field) { return obj[field + '_' + lang] || obj[field + '_ar'] || obj['title_' + lang] || obj['title_ar'] || ''; }
        
        // ==================== INIT ====================
        async function init() {
            try {
                const { data: s } = await db.from('settings').select('*').limit(1).single();
                if (s) settings = s;
                
                const { data: nodes } = await db.from('flow_nodes').select('*').eq('is_active', true).order('sort_order');
                flowNodes = nodes || [];
                console.log('Loaded nodes:', flowNodes.length);
                
                const { data: f } = await db.from('files').select('*').eq('is_active', true);
                files = f || [];
                console.log('Loaded files:', files.length);
                
                applyLang();
                showMainMenu();
            } catch (e) {
                console.error('Init error:', e);
                document.getElementById('chat').innerHTML = `<div class="loading">âŒ ${t('error')}</div>`;
            }
        }
        
        // ==================== LANGUAGE ====================
        window.switchLang = (newLang) => {
            lang = newLang;
            localStorage.setItem('chat_lang', lang);
            applyLang();
            showMainMenu();
        };
        
        function applyLang() {
            document.body.className = lang === 'en' ? 'en' : '';
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('btnAr').className = 'lang-btn' + (lang === 'ar' ? ' active' : '');
            document.getElementById('btnEn').className = 'lang-btn' + (lang === 'en' ? ' active' : '');
            document.getElementById('headerTitle').textContent = t('title');
            document.getElementById('headerSubtitle').textContent = t('subtitle');
            document.getElementById('userInput').placeholder = t('placeholder');
        }
        
        // ==================== CHAT FUNCTIONS ====================
        function getTime() {
            return new Date().toLocaleTimeString(lang === 'ar' ? 'ar-SA' : 'en-US', { hour: '2-digit', minute: '2-digit' });
        }
        
        function scrollToBottom() {
            const chat = document.getElementById('chat');
            setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 100);
        }
        
        function showTyping() {
            hideTyping();
            const div = document.createElement('div');
            div.className = 'msg bot';
            div.id = 'typingIndicator';
            div.innerHTML = `
                <div class="msg-avatar">ğŸ¤–</div>
                <div class="msg-content">
                    <div class="typing"><span></span><span></span><span></span></div>
                </div>
            `;
            document.getElementById('chat').appendChild(div);
            scrollToBottom();
        }
        
        function hideTyping() {
            document.getElementById('typingIndicator')?.remove();
        }
        
        function addBotMessage(text, extra = '') {
            hideTyping();
            const div = document.createElement('div');
            div.className = 'msg bot';
            div.innerHTML = `
                <div class="msg-avatar">ğŸ¤–</div>
                <div class="msg-content">
                    ${text ? `<div class="msg-bubble">${text}</div>` : ''}
                    ${extra}
                    <div class="msg-time">${getTime()}</div>
                </div>
            `;
            document.getElementById('chat').appendChild(div);
            scrollToBottom();
        }
        
        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'msg user';
            div.innerHTML = `
                <div class="msg-avatar">ğŸ‘¤</div>
                <div class="msg-content">
                    <div class="msg-bubble">${text}</div>
                    <div class="msg-time">${getTime()}</div>
                </div>
            `;
            document.getElementById('chat').appendChild(div);
            scrollToBottom();
        }
        
        // ==================== NAVIGATION ====================
        function showMainMenu() {
            document.getElementById('chat').innerHTML = '';
            currentNode = null;
            collectedData = {};
            awaitingInput = false;
            history = [];
            visitedNodes = [];
            
            const roots = flowNodes.filter(n => !n.parent_id);
            
            if (!roots.length) {
                addBotMessage(t('noData'));
                return;
            }
            
            showTyping();
            setTimeout(() => {
                const buttons = roots.map(n => `
                    <button class="menu-btn" onclick="selectNode('${n.id}')">
                        <span class="icon">${n.icon}</span>
                        <span class="label">${getLabel(n, 'title')}</span>
                    </button>
                `).join('');
                
                addBotMessage(t('welcome'), `<div class="btn-grid">${buttons}</div>`);
            }, 400);
        }
        
        window.selectNode = (nodeId) => {
            const node = flowNodes.find(n => n.id === nodeId);
            if (!node) return;
            
            console.log('Selected node:', node.title_ar, 'Type:', node.node_type);
            
            history.push(currentNode?.id || null);
            currentNode = node;
            visitedNodes.push(node.id);
            
            // Ù„Ø§ ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            if (node.node_type !== 'section' || node.parent_id) {
                addUserMessage(getLabel(node, 'title'));
            }
            
            // If this is an action node, execute it
            if (node.node_type === 'action') {
                executeAction(node);
                return;
            }
            
            // Get children
            const children = getValidChildren(node.id);
            console.log('Children count:', children.length);
            
            // If this is a question node
            if (node.node_type === 'question') {
                askQuestion(node);
                return;
            }
            
            // If section node with children
            if (children.length > 0) {
                // Check if all children are questions - ask first one
                const firstQuestion = children.find(c => c.node_type === 'question');
                const firstAction = children.find(c => c.node_type === 'action');
                
                if (firstQuestion) {
                    // Go directly to first question
                    setTimeout(() => selectNode(firstQuestion.id), 300);
                } else if (firstAction) {
                    // Execute action directly
                    setTimeout(() => selectNode(firstAction.id), 300);
                } else {
                    // Show children as buttons
                    showChildren(children);
                }
            } else {
                // No children - look for action in path
                findAndExecuteAction();
            }
        };
        
        function getValidChildren(parentId) {
            return flowNodes.filter(n => {
                if (n.parent_id !== parentId) return false;
                
                // Check condition
                if (n.show_condition) {
                    try {
                        const cond = typeof n.show_condition === 'string' ? JSON.parse(n.show_condition) : n.show_condition;
                        if (cond.var && cond.equals) {
                            if (collectedData[cond.var] !== cond.equals) return false;
                        }
                    } catch (e) {}
                }
                
                return true;
            }).sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
        }
        
        function showChildren(children) {
            showTyping();
            setTimeout(() => {
                const buttons = children.map(c => `
                    <button class="quick-btn" onclick="selectNode('${c.id}')">${c.icon} ${getLabel(c, 'title')}</button>
                `).join('');
                
                addBotMessage('', `<div class="quick-btns">${buttons}</div>${getBackButton()}`);
            }, 400);
        }
        
        function askQuestion(node) {
            awaitingInput = true;
            showTyping();
            
            setTimeout(() => {
                if (node.input_type === 'select' && node.options) {
                    let options;
                    try {
                        options = typeof node.options === 'string' ? JSON.parse(node.options) : node.options;
                    } catch (e) {
                        options = [];
                    }
                    
                    if (options.length > 0) {
                        const buttons = options.map(opt => {
                            const label = opt.label_ar || opt.label || opt.value;
                            return `<button class="quick-btn" onclick="answerQuestion('${opt.value}')">${label}</button>`;
                        }).join('');
                        
                        addBotMessage(`${node.icon} ${getLabel(node, 'title')}`, `<div class="quick-btns">${buttons}</div>${getBackButton()}`);
                    } else {
                        addBotMessage(`${node.icon} ${getLabel(node, 'title')}`, getBackButton());
                        document.getElementById('userInput').focus();
                    }
                } else {
                    addBotMessage(`${node.icon} ${getLabel(node, 'title')}`, getBackButton());
                    document.getElementById('userInput').focus();
                }
            }, 400);
        }
        
        window.answerQuestion = (answer) => {
            if (!awaitingInput || !currentNode) return;
            
            console.log('Answer:', answer, 'for var:', currentNode.var_name);
            
            // Save answer
            if (currentNode.var_name) {
                collectedData[currentNode.var_name] = answer;
            }
            
            addUserMessage(answer);
            awaitingInput = false;
            
            // Get children of current question
            const children = getValidChildren(currentNode.id);
            console.log('Children after answer:', children.length);
            
            if (children.length > 0) {
                // Check for next question or action
                const nextQuestion = children.find(c => c.node_type === 'question');
                const action = children.find(c => c.node_type === 'action');
                
                if (nextQuestion) {
                    setTimeout(() => selectNode(nextQuestion.id), 300);
                } else if (action) {
                    setTimeout(() => selectNode(action.id), 300);
                } else {
                    showChildren(children);
                }
            } else {
                // No children - look for action in siblings or parent path
                console.log('No children, looking for action...');
                findAndExecuteAction();
            }
        };
        
        // ==================== FIND ACTION IN PATH ====================
        function findAndExecuteAction() {
            console.log('Finding action... Collected data:', collectedData);
            
            // Strategy 1: Look for action node that is sibling of any visited node
            for (const visitedId of visitedNodes) {
                const visited = flowNodes.find(n => n.id === visitedId);
                if (!visited) continue;
                
                // Get siblings (same parent)
                const siblings = flowNodes.filter(n => n.parent_id === visited.parent_id && n.id !== visitedId);
                const siblingAction = siblings.find(s => s.node_type === 'action');
                
                if (siblingAction) {
                    console.log('Found sibling action:', siblingAction.title_ar);
                    executeAction(siblingAction);
                    return;
                }
            }
            
            // Strategy 2: Look for action in parent chain
            let checkNode = currentNode;
            while (checkNode) {
                const parent = flowNodes.find(n => n.id === checkNode.parent_id);
                if (!parent) break;
                
                // Check siblings of current node's parent
                const siblings = flowNodes.filter(n => n.parent_id === parent.id);
                const action = siblings.find(s => s.node_type === 'action');
                
                if (action) {
                    console.log('Found action in parent path:', action.title_ar);
                    executeAction(action);
                    return;
                }
                
                checkNode = parent;
            }
            
            // Strategy 3: Look for any action connected to root section
            const rootSection = findRootSection(currentNode);
            if (rootSection) {
                const rootChildren = flowNodes.filter(n => n.parent_id === rootSection.id);
                const rootAction = rootChildren.find(c => c.node_type === 'action');
                
                if (rootAction) {
                    console.log('Found action in root section:', rootAction.title_ar);
                    executeAction(rootAction);
                    return;
                }
            }
            
            // No action found
            console.log('No action found in path');
            addBotMessage(t('noAction'), getNavButtons());
        }
        
        function findRootSection(node) {
            if (!node) return null;
            if (!node.parent_id) return node;
            
            const parent = flowNodes.find(n => n.id === node.parent_id);
            return findRootSection(parent);
        }
        
        // ==================== EXECUTE ACTION ====================
        async function executeAction(node) {
            console.log('Executing action:', node.title_ar, 'Type:', node.action_type);
            showTyping();
            
            const actionType = node.action_type;
            const actionData = node.action_data || {};
            
            // Build data summary
            let dataSummaryHtml = '';
            if (Object.keys(collectedData).length) {
                dataSummaryHtml = `
                    <div class="data-summary">
                        <div class="data-summary-title">${t('yourData')}</div>
                        ${Object.entries(collectedData).map(([k, v]) => `
                            <div class="data-row">
                                <span class="key">${k}</span>
                                <span class="value">${v}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            setTimeout(async () => {
                try {
                    if (actionType === 'file_ai') {
                        addBotMessage(t('searching'), dataSummaryHtml);
                        const result = await searchInFile(node);
                        hideTyping();
                        addBotMessage('', `
                            <div class="ai-badge">${t('aiAnswer')}</div>
                            <div class="info-card">${result}</div>
                            ${getNavButtons()}
                        `);
                    }
                    else if (actionType === 'static') {
                        const response = getLabel(actionData, 'response') || actionData.response_ar || '';
                        addBotMessage('', `${dataSummaryHtml}<div class="info-card">${response}</div>${getNavButtons()}`);
                    }
                    else if (actionType === 'phone') {
                        const phone = actionData.phone || '';
                        addBotMessage('', `
                            ${dataSummaryHtml}
                            <div class="contact-card">
                                <a href="tel:${phone}">${t('call')}<br><span style="font-size:22px;margin-top:8px;display:block;">${phone}</span></a>
                            </div>
                            ${getNavButtons()}
                        `);
                    }
                    else if (actionType === 'whatsapp') {
                        const phone = actionData.phone || '';
                        const waLink = 'https://wa.me/' + phone.replace(/[^0-9]/g, '');
                        addBotMessage('', `
                            ${dataSummaryHtml}
                            <div class="contact-card whatsapp">
                                <a href="${waLink}" target="_blank">${t('whatsapp')}<br><span style="font-size:22px;margin-top:8px;display:block;">${phone}</span></a>
                            </div>
                            ${getNavButtons()}
                        `);
                    }
                    else if (actionType === 'webhook') {
                        await sendWebhook(node);
                        addBotMessage('', `${dataSummaryHtml}<div class="info-card">ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</div>${getNavButtons()}`);
                    }
                    else {
                        addBotMessage('', `${dataSummaryHtml}<div class="error-card">${t('noAction')}</div>${getNavButtons()}`);
                    }
                } catch (e) {
                    console.error('Action error:', e);
                    addBotMessage('', `<div class="error-card">${t('error')}: ${e.message}</div>${getNavButtons()}`);
                }
            }, 500);
        }
        
        // ==================== SMART FILE SEARCH ====================
        async function searchInFile(node) {
            const file = files.find(f => f.id === node.action_file_id);
            
            if (!file) {
                console.error('File not found for action');
                return t('notFound') + ' (Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯)';
            }
            
            console.log('Searching in file:', file.original_name || file.file_name);
            console.log('Search data:', collectedData);
            
            try {
                // Download file
                const { data: fileBlob, error: downloadError } = await db.storage.from('files').download(file.file_name);
                
                if (downloadError) {
                    console.error('Download error:', downloadError);
                    return t('error') + ': ' + downloadError.message;
                }
                
                if (!fileBlob) {
                    return t('notFound') + ' (ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù)';
                }
                
                const ext = file.file_name.split('.').pop().toLowerCase();
                console.log('File extension:', ext);
                
                // For Excel files - SMART SEARCH
                if (['xlsx', 'xls', 'csv'].includes(ext)) {
                    const arrayBuffer = await fileBlob.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer);
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    console.log('Excel rows:', jsonData.length);
                    console.log('First row sample:', jsonData[0]);
                    
                    // Get column names
                    const columnNames = jsonData.length > 0 ? Object.keys(jsonData[0]) : [];
                    console.log('Column names:', columnNames);
                    
                    // Search for matching rows
                    let foundRows = [];
                    
                    for (const row of jsonData) {
                        let matchScore = 0;
                        
                        for (const [searchKey, searchValue] of Object.entries(collectedData)) {
                            if (!searchValue) continue;
                            
                            const searchValueStr = String(searchValue).trim().toLowerCase();
                            
                            // Try to find matching column
                            for (const colName of columnNames) {
                                const colNameLower = colName.toLowerCase();
                                const rowValue = row[colName];
                                
                                if (rowValue === undefined || rowValue === null) continue;
                                
                                const rowValueStr = String(rowValue).trim().toLowerCase();
                                
                                // Check if column name matches search key or if values match
                                const keyMatches = colNameLower.includes(searchKey.toLowerCase()) || 
                                                   searchKey.toLowerCase().includes(colNameLower);
                                
                                if (keyMatches || colNameLower.includes('id') || colNameLower.includes('name') || colNameLower.includes('Ø§Ø³Ù…')) {
                                    if (rowValueStr === searchValueStr || 
                                        rowValueStr.includes(searchValueStr) || 
                                        searchValueStr.includes(rowValueStr)) {
                                        matchScore++;
                                    }
                                }
                            }
                        }
                        
                        if (matchScore > 0) {
                            foundRows.push({ row, score: matchScore });
                        }
                    }
                    
                    // Sort by score and get best matches
                    foundRows.sort((a, b) => b.score - a.score);
                    console.log('Found rows:', foundRows.length);
                    
                    if (foundRows.length > 0) {
                        // Take top 5 matches
                        const topMatches = foundRows.slice(0, 5).map(f => f.row);
                        return await formatWithGemini(file, topMatches);
                    } else {
                        // No exact match - send sample data to Gemini
                        return await askGeminiForHelp(file, jsonData.slice(0, 20));
                    }
                }
                // For PDF/other files
                else {
                    const text = await fileBlob.text();
                    return await askGeminiWithText(file, text);
                }
            } catch (e) {
                console.error('Search error:', e);
                return t('error') + ': ' + e.message;
            }
        }
        
        async function formatWithGemini(file, foundData) {
            if (!settings.gemini_key) {
                // Return raw data if no Gemini
                return JSON.stringify(foundData, null, 2);
            }
            
            const prompt = `${file.ai_prompt || 'Ù‚Ù… Ø¨Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø³Ù‚ ÙˆÙˆØ§Ø¶Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…'}

Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
${JSON.stringify(collectedData, null, 2)}

Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:
${JSON.stringify(foundData, null, 2)}

Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
- Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ ÙˆÙ…Ù†Ø¸Ù…
- Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø£ÙƒØ«Ø± Ù…Ù† Ù†ØªÙŠØ¬Ø©ØŒ Ø§Ø¹Ø±Ø¶Ù‡Ø§ ÙƒÙ„Ù‡Ø§
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
- ÙƒÙ† Ù…Ø®ØªØµØ±Ø§Ù‹ ÙˆÙ…ÙÙŠØ¯Ø§Ù‹`;

            return await callGeminiAPI(prompt);
        }
        
        async function askGeminiForHelp(file, sampleData) {
            if (!settings.gemini_key) {
                return t('notFound');
            }
            
            const prompt = `${file.ai_prompt || 'Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø§ÙˆÙ„ Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ø§ ÙŠØ·Ù„Ø¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'}

Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ¨Ø­Ø« Ø¹Ù†Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
${JSON.stringify(collectedData, null, 2)}

Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (${sampleData.length} ØµÙ):
${JSON.stringify(sampleData, null, 2)}

Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
- Ø­Ø§ÙˆÙ„ Ø¥ÙŠØ¬Ø§Ø¯ Ø£Ù‚Ø±Ø¨ ØªØ·Ø§Ø¨Ù‚
- Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚ Ù…Ø¨Ø§Ø´Ø±ØŒ Ø£Ø®Ø¨Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø°Ù„Ùƒ
- Ø§Ù‚ØªØ±Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙŠÙ„Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©`;

            return await callGeminiAPI(prompt);
        }
        
        async function askGeminiWithText(file, text) {
            if (!settings.gemini_key) {
                return text.substring(0, 500) + '...';
            }
            
            const limitedText = text.substring(0, 8000);
            
            const prompt = `${file.ai_prompt || 'Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙˆØ£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ø³ØªÙØ³Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'}

Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
${JSON.stringify(collectedData, null, 2)}

Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªÙ†Ø¯:
${limitedText}

Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
- Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
- Ù‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø®ØªØµØ±Ø© ÙˆÙ…ÙÙŠØ¯Ø©
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©`;

            return await callGeminiAPI(prompt);
        }
        
        async function callGeminiAPI(prompt) {
            try {
                const response = await fetch(`${GEMINI_API}?key=${settings.gemini_key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Gemini API error:', data.error);
                    return t('error') + ': ' + (data.error.message || 'API Error');
                }
                
                return data.candidates?.[0]?.content?.parts?.[0]?.text || t('error');
            } catch (e) {
                console.error('Gemini call error:', e);
                return t('error') + ': ' + e.message;
            }
        }
        
        async function sendWebhook(node) {
            const webhookUrl = node.action_data?.webhook || settings.webhook_url;
            if (!webhookUrl) return;
            
            await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    node: node.title_ar,
                    data: collectedData,
                    timestamp: new Date().toISOString()
                }),
                mode: 'no-cors'
            }).catch(() => {});
        }
        
        // ==================== NAVIGATION BUTTONS ====================
        function getNavButtons() {
            return `<div class="quick-btns" style="margin-top:14px;"><button class="quick-btn green" onclick="goHome()">${t('home')}</button></div>`;
        }
        
        function getBackButton() {
            return `<button class="back-btn" onclick="goBack()">${t('back')}</button>`;
        }
        
        window.goBack = () => {
            if (!history.length) {
                goHome();
                return;
            }
            
            addUserMessage(t('back'));
            awaitingInput = false;
            
            const prevId = history.pop();
            visitedNodes.pop();
            
            if (!prevId) {
                showMainMenu();
            } else {
                currentNode = flowNodes.find(n => n.id === prevId);
                const children = getValidChildren(prevId);
                if (children.length) {
                    showChildren(children);
                } else {
                    showMainMenu();
                }
            }
        };
        
        window.goHome = () => {
            addUserMessage(t('home'));
            showMainMenu();
        };
        
        // ==================== USER INPUT ====================
        window.handleUserInput = () => {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            
            if (awaitingInput) {
                answerQuestion(text);
            } else {
                // Free text - general AI
                addUserMessage(text);
                showTyping();
                setTimeout(async () => {
                    const response = await freeAI(text);
                    addBotMessage('', `<div class="ai-badge">${t('aiAnswer')}</div><div class="info-card">${response}</div>${getNavButtons()}`);
                }, 500);
            }
        };
        
        async function freeAI(question) {
            if (!settings.gemini_key) return 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ Gemini API Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…';
            
            const prompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†. Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ± ÙˆÙ…ÙÙŠØ¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:

${question}`;
            
            return await callGeminiAPI(prompt);
        }
        
        // Enter key handler
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleUserInput();
        });
        
        // Start
        init();
    </script>
</body>
</html>
