<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5; --primary-light: #EEF2FF;
            --success: #10B981; --success-light: #D1FAE5;
            --bg: #F8FAFC; --card: #FFFFFF;
            --text: #1E293B; --text-light: #64748B; --border: #E2E8F0;
            --gradient: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 16px; }
        body.en { direction: ltr; font-family: 'Inter', sans-serif; }
        
        .container { width: 100%; max-width: 460px; height: 94vh; max-height: 820px; background: var(--card); border-radius: 24px; box-shadow: 0 20px 60px rgba(79,70,229,0.15); display: flex; flex-direction: column; overflow: hidden; }
        
        .header { background: var(--gradient); padding: 18px; color: white; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .lang-switch { display: flex; background: rgba(255,255,255,0.15); border-radius: 8px; overflow: hidden; }
        .lang-btn { padding: 6px 12px; background: transparent; border: none; color: rgba(255,255,255,0.7); font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .lang-btn.active { background: rgba(255,255,255,0.25); color: white; }
        .header-main { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .header-info h1 { font-size: 16px; font-weight: 700; }
        .header-info p { font-size: 11px; opacity: 0.9; }
        
        .chat { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { display: flex; gap: 8px; animation: fadeIn 0.3s; }
        .msg.user { flex-direction: row-reverse; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .msg-avatar { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .msg.bot .msg-avatar { background: var(--primary-light); }
        .msg.user .msg-avatar { background: var(--gradient); color: white; }
        .msg-content { max-width: 85%; }
        .msg-bubble { padding: 10px 14px; border-radius: 16px; font-size: 13px; line-height: 1.6; }
        .msg.bot .msg-bubble { background: var(--bg); color: var(--text); border-bottom-right-radius: 4px; }
        body.en .msg.bot .msg-bubble { border-bottom-right-radius: 16px; border-bottom-left-radius: 4px; }
        .msg.user .msg-bubble { background: var(--gradient); color: white; border-bottom-left-radius: 4px; }
        .msg-time { font-size: 9px; color: var(--text-light); margin-top: 3px; }
        
        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
        .menu-btn { padding: 14px 10px; background: white; border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px; font-family: inherit; }
        .menu-btn:hover { border-color: var(--primary); background: var(--primary-light); }
        .menu-btn .icon { font-size: 24px; }
        .menu-btn .label { font-size: 12px; font-weight: 600; color: var(--text); }
        
        .quick-btns { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .quick-btn { padding: 9px 14px; background: white; border: 2px solid var(--primary); border-radius: 20px; color: var(--primary); font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .quick-btn:hover { background: var(--primary); color: white; }
        .quick-btn.green { border-color: var(--success); color: var(--success); }
        .quick-btn.green:hover { background: var(--success); color: white; }
        
        .info-card { background: linear-gradient(135deg, var(--primary-light), #F3E8FF); border-radius: 12px; padding: 12px; margin-top: 10px; white-space: pre-line; font-size: 13px; line-height: 1.6; }
        
        .contact-card { background: var(--success-light); border-radius: 12px; padding: 14px; margin-top: 10px; text-align: center; }
        .contact-card a { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--success); color: white; text-decoration: none; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .contact-card.whatsapp a { background: #25D366; }
        
        .ai-badge { display: inline-flex; align-items: center; gap: 4px; background: #DBEAFE; color: #1D4ED8; padding: 3px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; margin-bottom: 6px; }
        
        .file-download { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .file-link { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: white; border: 1px solid var(--border); border-radius: 8px; color: var(--text); text-decoration: none; font-size: 11px; font-weight: 600; }
        .file-link:hover { background: var(--primary-light); border-color: var(--primary); }
        
        .back-btn { display: inline-flex; align-items: center; gap: 4px; padding: 6px 14px; background: white; border: 1px solid var(--border); border-radius: 16px; color: var(--text-light); font-family: inherit; font-size: 11px; cursor: pointer; margin-top: 10px; }
        .back-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        .typing { display: flex; gap: 4px; padding: 12px 16px; background: var(--bg); border-radius: 16px; width: fit-content; }
        .typing span { width: 6px; height: 6px; background: var(--text-light); border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
        
        .input-area { padding: 12px 14px; background: white; border-top: 1px solid var(--border); }
        .input-wrap { display: flex; gap: 8px; }
        .input-field { flex: 1; padding: 10px 16px; border: 2px solid var(--border); border-radius: 22px; font-family: inherit; font-size: 13px; outline: none; }
        .input-field:focus { border-color: var(--primary); }
        .send-btn { width: 44px; height: 44px; background: var(--gradient); border: none; border-radius: 50%; color: white; font-size: 16px; cursor: pointer; }
        
        .collected-data { background: var(--bg); border-radius: 8px; padding: 8px 12px; margin-top: 8px; font-size: 11px; }
        .collected-data .item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid var(--border); }
        .collected-data .item:last-child { border: none; }
        
        .loading { text-align: center; padding: 30px; color: var(--text-light); }
        .loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 500px) { body { padding: 0; } .container { height: 100vh; max-height: none; border-radius: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div></div>
                <div class="lang-switch">
                    <button class="lang-btn active" id="btnAr" onclick="switchLang('ar')">Ø¹Ø±Ø¨ÙŠ</button>
                    <button class="lang-btn" id="btnEn" onclick="switchLang('en')">EN</button>
                </div>
            </div>
            <div class="header-main">
                <div class="avatar">ğŸ¤–</div>
                <div class="header-info">
                    <h1 id="title">Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
                    <p id="subtitle">Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                </div>
            </div>
        </div>
        <div class="chat" id="chat">
            <div class="loading"><div class="loading-spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        </div>
        <div class="input-area">
            <div class="input-wrap">
                <input type="text" class="input-field" id="input" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." autocomplete="off">
                <button class="send-btn" onclick="handleInput()">â¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const SUPABASE_URL = 'https://nrsnsysjmhboovutirdn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yc25zeXNqbWhib292dXRpcmRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDYxNjYsImV4cCI6MjA4NzE4MjE2Nn0.A6XRe0wUA267hogwWnNpXe08B-MrL1HSjBVbURyLdsU';
        const GEMINI_API = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let nodes = [], settings = {};
        let lang = localStorage.getItem('appLang') || 'ar';
        let history = [], currentNode = null;
        let collectedData = {}; // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
        let awaitingInput = null; // Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¸Ø± Ø¥Ø¬Ø§Ø¨ØªÙ‡
        
        const L = {
            ar: { title: 'Ù…Ø±ÙƒØ² Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', subtitle: 'Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ', welcome: 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹<br>ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ', placeholder: 'Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...', back: 'â†’ Ø±Ø¬ÙˆØ¹', home: 'ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', aiAnswer: 'ğŸ¤– Ø¥Ø¬Ø§Ø¨Ø© AI', call: 'ğŸ“ Ø§ØªØµÙ„ Ø§Ù„Ø¢Ù†', whatsapp: 'ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨', download: 'ğŸ“¥ ØªØ­Ù…ÙŠÙ„', yourData: 'Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©:' },
            en: { title: 'Employee Support', subtitle: 'AI Powered', welcome: 'Welcome! ğŸ‘‹<br>How can I help?', placeholder: 'Type here...', back: 'â† Back', home: 'ğŸ  Home', aiAnswer: 'ğŸ¤– AI Answer', call: 'ğŸ“ Call', whatsapp: 'ğŸ’¬ WhatsApp', download: 'ğŸ“¥ Download', yourData: 'Your data:' }
        };

        async function loadData() {
            try {
                const { data: s } = await db.from('settings').select('*').limit(1).single();
                if (s) settings = s;
                
                const { data: n } = await db.from('nodes').select('*').eq('is_active', true).order('sort_order');
                nodes = n || [];
                
                showMain();
            } catch (e) {
                console.error(e);
                document.getElementById('chat').innerHTML = '<div class="loading">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>';
            }
        }

        window.switchLang = (l) => {
            lang = l;
            localStorage.setItem('appLang', l);
            document.body.className = l === 'en' ? 'en' : '';
            document.documentElement.lang = l;
            document.documentElement.dir = l === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('btnAr').className = 'lang-btn' + (l === 'ar' ? ' active' : '');
            document.getElementById('btnEn').className = 'lang-btn' + (l === 'en' ? ' active' : '');
            document.getElementById('title').textContent = L[l].title;
            document.getElementById('subtitle').textContent = L[l].subtitle;
            document.getElementById('input').placeholder = L[l].placeholder;
            showMain();
        };

        function T(k) { return L[lang][k]; }
        function getName(obj, field) { return obj[field + '_' + lang] || obj[field + '_ar'] || ''; }
        function time() { return new Date().toLocaleTimeString(lang === 'ar' ? 'ar-EG' : 'en-US', { hour: '2-digit', minute: '2-digit' }); }
        function scroll() { document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight; }

        function typing() {
            const d = document.createElement('div');
            d.className = 'msg bot'; d.id = 'typing';
            d.innerHTML = `<div class="msg-avatar">ğŸ¤–</div><div class="msg-content"><div class="typing"><span></span><span></span><span></span></div></div>`;
            document.getElementById('chat').appendChild(d);
            scroll();
        }

        function untype() { document.getElementById('typing')?.remove(); }

        function bot(txt, extra = '') {
            untype();
            const d = document.createElement('div');
            d.className = 'msg bot';
            d.innerHTML = `<div class="msg-avatar">ğŸ¤–</div><div class="msg-content">${txt ? `<div class="msg-bubble">${txt}</div>` : ''}${extra}<div class="msg-time">${time()}</div></div>`;
            document.getElementById('chat').appendChild(d);
            scroll();
        }

        function user(txt) {
            const d = document.createElement('div');
            d.className = 'msg user';
            d.innerHTML = `<div class="msg-avatar">ğŸ‘¤</div><div class="msg-content"><div class="msg-bubble">${txt}</div><div class="msg-time">${time()}</div></div>`;
            document.getElementById('chat').appendChild(d);
            scroll();
        }

        function showMain() {
            document.getElementById('chat').innerHTML = '';
            history = [];
            currentNode = null;
            collectedData = {};
            awaitingInput = null;
            
            const rootNodes = nodes.filter(n => !n.parent_id);
            if (!rootNodes.length) { bot('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }

            typing();
            setTimeout(() => {
                let btns = rootNodes.map(n => 
                    `<button class="menu-btn" onclick="openNode('${n.id}')"><span class="icon">${n.icon}</span><span class="label">${getName(n, 'label')}</span></button>`
                ).join('');
                bot(T('welcome'), `<div class="btn-grid">${btns}</div>`);
            }, 300);
        }

        window.openNode = (nodeId) => {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;
            
            if (currentNode) history.push(currentNode.id);
            else history.push(null);
            
            currentNode = node;
            user(getName(node, 'label'));
            
            // Ù„Ùˆ Ø³Ø¤Ø§Ù„
            if (node.is_question) {
                handleQuestion(node);
                return;
            }
            
            // Ù„Ùˆ ÙØ±Ø¹ Ù…Ø¹ Ø£ÙˆÙ„Ø§Ø¯
            const children = nodes.filter(n => n.parent_id === nodeId);
            if (node.node_type !== 'endpoint' && children.length) {
                typing();
                setTimeout(() => {
                    let btns = children.map(c => 
                        `<button class="quick-btn" onclick="openNode('${c.id}')">${c.icon} ${getName(c, 'label')}</button>`
                    ).join('');
                    bot(`${node.icon} ${getName(node, 'label')}`, `<div class="quick-btns">${btns}</div><button class="back-btn" onclick="goBack()">${T('back')}</button>`);
                }, 300);
                return;
            }
            
            // Ù„Ùˆ Ù†Ù‡Ø§ÙŠØ©
            handleEndpoint(node);
        };

        function handleQuestion(node) {
            awaitingInput = node;
            
            typing();
            setTimeout(() => {
                const qType = node.question_type || 'text';
                
                if (qType === 'select' && node.question_options) {
                    const options = node.question_options.split('\n').filter(o => o.trim());
                    let btns = options.map(o => `<button class="quick-btn" onclick="answerQuestion('${o.trim()}')">${o.trim()}</button>`).join('');
                    bot(getName(node, 'label'), `<div class="quick-btns">${btns}</div><button class="back-btn" onclick="goBack()">${T('back')}</button>`);
                } else {
                    bot(getName(node, 'label'), `<button class="back-btn" onclick="goBack()">${T('back')}</button>`);
                    document.getElementById('input').focus();
                    document.getElementById('input').placeholder = qType === 'number' ? '123...' : qType === 'date' ? 'YYYY-MM-DD' : T('placeholder');
                }
            }, 300);
        }

        window.answerQuestion = (answer) => {
            if (!awaitingInput) return;
            
            const key = awaitingInput.question_key || 'answer';
            collectedData[key] = answer;
            user(answer);
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„ØªØ§Ù„ÙŠ
            const children = nodes.filter(n => n.parent_id === awaitingInput.id);
            awaitingInput = null;
            
            if (children.length) {
                // Ù„Ùˆ ÙÙŠ Ø£ÙˆÙ„Ø§Ø¯ Ù†Ø¹Ø±Ø¶Ù‡Ù…
                typing();
                setTimeout(() => {
                    if (children.length === 1) {
                        openNode(children[0].id);
                    } else {
                        let btns = children.map(c => 
                            `<button class="quick-btn" onclick="openNode('${c.id}')">${c.icon} ${getName(c, 'label')}</button>`
                        ).join('');
                        bot('', `<div class="quick-btns">${btns}</div><button class="back-btn" onclick="goBack()">${T('back')}</button>`);
                    }
                }, 300);
            } else {
                // Ù„Ùˆ Ù…ÙÙŠØ´ Ø£ÙˆÙ„Ø§Ø¯ ÙŠØ¹Ù†ÙŠ Ù†Ù‡Ø§ÙŠØ©
                handleEndpoint(currentNode);
            }
        };

        function handleEndpoint(node) {
            const type = node.endpoint_type || 'ai';
            
            typing();
            setTimeout(async () => {
                if (type === 'ai') {
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
                    let dataHtml = '';
                    if (Object.keys(collectedData).length) {
                        dataHtml = `<div class="collected-data"><strong>${T('yourData')}</strong>${Object.entries(collectedData).map(([k,v]) => `<div class="item"><span>${k}:</span><span>${v}</span></div>`).join('')}</div>`;
                    }
                    
                    bot('ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...', dataHtml);
                    
                    const answer = await askGemini(node);
                    untype();
                    
                    // Ø±ÙˆØ§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
                    let filesHtml = '';
                    if (node.files?.length) {
                        filesHtml = `<div class="file-download">${node.files.map(f => {
                            const url = `${SUPABASE_URL}/storage/v1/object/public/files/${f}`;
                            return `<a class="file-link" href="${url}" target="_blank">ğŸ“ ${f}</a>`;
                        }).join('')}</div>`;
                    }
                    
                    bot('', `<div class="ai-badge">${T('aiAnswer')}</div><div class="info-card">${answer}</div>${filesHtml}${navButtons()}`);
                }
                else if (type === 'static') {
                    const resp = getName(node, 'response') || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø©';
                    bot('', `<div class="info-card">${resp}</div>${navButtons()}`);
                }
                else if (type === 'phone') {
                    const phone = node.phone_number || '';
                    bot('', `<div class="contact-card"><a href="tel:${phone}">${T('call')}<br><span style="font-size:16px;">${phone}</span></a></div>${navButtons()}`);
                }
                else if (type === 'whatsapp') {
                    const phone = node.phone_number || '';
                    const waLink = `https://wa.me/${phone.replace(/[^0-9]/g, '')}`;
                    bot('', `<div class="contact-card whatsapp"><a href="${waLink}" target="_blank">${T('whatsapp')}<br><span style="font-size:16px;">${phone}</span></a></div>${navButtons()}`);
                }
                else if (type === 'webhook') {
                    sendWebhook(node);
                    bot('', `<div class="info-card">ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ</div>${navButtons()}`);
                }
            }, 400);
        }

        function navButtons() {
            return `<div class="quick-btns" style="margin-top:10px;"><button class="quick-btn green" onclick="goHome()">${T('home')}</button></div><button class="back-btn" onclick="goBack()">${T('back')}</button>`;
        }

        async function askGemini(node) {
            if (!settings.gemini_key) return 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ AI';
            
            try {
                // ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„ÙØ§Øª
                let filesContent = '';
                if (node.files?.length) {
                    for (const fileName of node.files) {
                        try {
                            const { data } = await db.storage.from('files').download(fileName);
                            if (data) {
                                const text = await data.text();
                                filesContent += `\n\n=== Ù…Ù„Ù: ${fileName} ===\n${text}`;
                            }
                        } catch (e) { console.error('Error loading file:', fileName, e); }
                    }
                }
                
                // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
                const userData = Object.entries(collectedData).map(([k,v]) => `${k}: ${v}`).join('\n');
                const basePrompt = node.ai_prompt || 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ. Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.';
                
                const fullPrompt = `${basePrompt}

Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
${userData || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'}

Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:
${filesContent || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª'}

Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ£Ø¹Ø·Ù‡ Ø¥Ø¬Ø§Ø¨Ø© Ù…ÙÙŠØ¯Ø© ÙˆÙ…Ø®ØªØµØ±Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`;

                const res = await fetch(`${GEMINI_API}?key=${settings.gemini_key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });
                
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
            } catch (e) {
                console.error('Gemini error:', e);
                return 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
            }
        }

        function sendWebhook(node) {
            if (!settings.webhook_url) return;
            const payload = {
                type: 'endpoint',
                node_id: node.id,
                label: getName(node, 'label'),
                collected_data: collectedData,
                timestamp: new Date().toISOString()
            };
            fetch(settings.webhook_url, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' }).catch(() => {});
        }

        window.handleInput = () => {
            const inp = document.getElementById('input');
            const txt = inp.value.trim();
            if (!txt) return;
            inp.value = '';
            
            if (awaitingInput) {
                answerQuestion(txt);
            } else {
                // Ø³Ø¤Ø§Ù„ Ø­Ø±
                user(txt);
                typing();
                setTimeout(async () => {
                    const answer = await freeQuestion(txt);
                    bot('', `<div class="ai-badge">${T('aiAnswer')}</div><div class="info-card">${answer}</div><div class="quick-btns" style="margin-top:10px;"><button class="quick-btn green" onclick="goHome()">${T('home')}</button></div>`);
                }, 300);
            }
        };

        async function freeQuestion(question) {
            if (!settings.gemini_key) return 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ AI';
            try {
                const res = await fetch(`${GEMINI_API}?key=${settings.gemini_key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ© Ø°ÙƒÙŠ. Ø£Ø¬Ø¨ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ± ÙˆÙ…ÙÙŠØ¯.\n\nØ§Ù„Ø³Ø¤Ø§Ù„: ${question}` }] }] })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || 'Ø¹Ø°Ø±Ø§Ù‹';
            } catch (e) { return 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'; }
        }

        window.goBack = () => {
            if (!history.length) { showMain(); return; }
            user(T('back'));
            awaitingInput = null;
            
            const prevId = history.pop();
            if (!prevId) {
                currentNode = null;
                const rootNodes = nodes.filter(n => !n.parent_id);
                typing();
                setTimeout(() => {
                    let btns = rootNodes.map(n => `<button class="menu-btn" onclick="openNode('${n.id}')"><span class="icon">${n.icon}</span><span class="label">${getName(n, 'label')}</span></button>`).join('');
                    bot(T('welcome'), `<div class="btn-grid">${btns}</div>`);
                }, 200);
            } else {
                const prevNode = nodes.find(n => n.id === prevId);
                currentNode = prevNode;
                const children = nodes.filter(n => n.parent_id === prevId);
                typing();
                setTimeout(() => {
                    let btns = children.map(c => `<button class="quick-btn" onclick="openNode('${c.id}')">${c.icon} ${getName(c, 'label')}</button>`).join('');
                    bot(`${prevNode?.icon || ''} ${getName(prevNode, 'label')}`, `<div class="quick-btns">${btns}</div><button class="back-btn" onclick="goBack()">${T('back')}</button>`);
                }, 200);
            }
        };

        window.goHome = () => { user(T('home')); showMain(); };

        document.getElementById('input').addEventListener('keypress', e => { if (e.key === 'Enter') window.handleInput(); });
        
        document.getElementById('btnAr').className = 'lang-btn' + (lang === 'ar' ? ' active' : '');
        document.getElementById('btnEn').className = 'lang-btn' + (lang === 'en' ? ' active' : '');
        document.body.className = lang === 'en' ? 'en' : '';
        document.getElementById('title').textContent = L[lang].title;
        document.getElementById('input').placeholder = L[lang].placeholder;
        
        loadData();
    </script>
</body>
</html>
